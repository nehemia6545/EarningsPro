<!DOCTYPE html>
<html lang="he" dir="rtl" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Earnings Pro - Compact</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-body: #09090b; --bg-surface: #18181b; --bg-elevated: #27272a;
            --text-high: #f4f4f5; --text-med: #a1a1aa; --text-low: #52525b;
            --border: #3f3f46;
            --accent: #3b82f6; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --purple: #8b5cf6;
            --modal-overlay: rgba(0, 0, 0, 0.9);
            --font-main: 'Rubik', sans-serif; --font-num: 'Inter', sans-serif;
        }

        [data-theme="light"] {
            --bg-body: #f8fafc; --bg-surface: #ffffff; --bg-elevated: #f1f5f9;
            --text-high: #0f172a; --text-med: #64748b; --text-low: #94a3b8;
            --border: #e2e8f0;
            --modal-overlay: rgba(255, 255, 255, 0.95);
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-body); color: var(--text-high); font-family: var(--font-main); margin: 0; padding: 0; overflow-y: scroll; overflow-x: hidden; }
        .eng-font { font-family: var(--font-num); }

        /* HEADER */
        header { background-color: var(--bg-surface); border-bottom: 1px solid var(--border); padding: 8px 12px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .logo { font-size: 18px; font-weight: 700; letter-spacing: 0.5px; } .logo span { color: var(--accent); }
        .controls-group { display: flex; gap: 8px; }
        .icon-btn { background: var(--bg-elevated); border: 1px solid var(--border); color: var(--text-med); width: 30px; height: 30px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; }

        .nav-row { display: flex; justify-content: space-between; align-items: center; gap: 6px; margin-bottom: 8px; flex-wrap: wrap; }
        .date-controls { display: flex; align-items: center; gap: 4px; background: var(--bg-body); padding: 2px; border-radius: 6px; border: 1px solid var(--border); flex: 1; min-width: 130px; justify-content: space-between; }
        .nav-arrow { background: transparent; border: none; color: var(--text-med); font-size: 18px; padding: 2px 8px; cursor: pointer; }
        .current-date { font-weight: 500; font-size: 12px; direction: ltr; white-space: nowrap; }
        .view-switch { display: flex; background: var(--bg-body); padding: 2px; border-radius: 6px; border: 1px solid var(--border); }
        .v-btn { background: transparent; border: none; color: var(--text-med); padding: 4px 8px; font-size: 11px; cursor: pointer; border-radius: 4px; font-weight: 500; }
        .v-btn.active { background: var(--bg-elevated); color: var(--text-high); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .action-bar { display: flex; gap: 6px; align-items: center; }
        .search-wrap { flex: 1; position: relative; }
        .search-input { width: 100%; background: var(--bg-body); border: 1px solid var(--border); color: var(--text-high); padding: 6px 8px; border-radius: 6px; font-size: 12px; outline: none; }
        .btn-ui { background: var(--bg-elevated); border: 1px solid var(--border); color: var(--text-high); padding: 0 8px; height: 30px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 500; display: flex; align-items: center; gap: 4px; white-space: nowrap; }
        .btn-ui.active { background: var(--accent); border-color: var(--accent); color: white; }

        .filter-panel { display: none; background: var(--bg-surface); border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-top: 10px; }
        .filter-panel.show { display: block; animation: slideDown 0.2s ease-out; }
        .chip-container { display: flex; flex-wrap: wrap; gap: 6px; }
        .filter-chip { background: var(--bg-body); border: 1px solid var(--border); padding: 5px 10px; border-radius: 15px; font-size: 11px; color: var(--text-med); cursor: pointer; }
        .filter-chip.selected { background: rgba(59, 130, 246, 0.15); border-color: var(--accent); color: var(--accent); font-weight: 600; }
        .slider-wrap { padding: 0 10px; margin-top: 10px; }
        .noUi-connect { background: var(--accent); } .noUi-target { background: var(--border); border: none; height: 4px; } .noUi-handle { width: 16px; height: 16px; right: -8px; top: -6px; border-radius: 50%; background: var(--text-high); border: 1px solid var(--border); }

        /* --- COMPACT MOBILE GRID SYSTEM --- */
        .container { 
            max-width: 100%; 
            padding: 5px; /* Minimal padding */
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch; 
        }
        
        .grid-view { 
            display: grid; 
            gap: 2px; /* Very tight gap */
            width: 100%;
        }
        
        /* Desktop Default */
        .grid-view.month, .grid-view.week { grid-template-columns: repeat(7, 1fr); min-width: 1000px; }
        .grid-view.list { display: flex; flex-direction: column; gap: 10px; min-width: 100%; }

        /* MOBILE OVERRIDE FOR GRID */
        @media (max-width: 768px) {
            .grid-view.month, .grid-view.week {
                /* Shrink width to allow fitting 7 columns in smaller scroll area */
                min-width: 600px; 
                gap: 2px;
            }
            .container { padding: 2px; }
        }

        .cal-day { 
            background: var(--bg-surface); border: 1px solid var(--border); 
            border-radius: 4px; padding: 2px; 
            display: flex; flex-direction: column; gap: 2px; overflow: hidden; 
        }
        
        /* Desktop Day Height */
        @media (min-width: 769px) { .cal-day { min-height: 140px; padding: 8px; gap: 6px; } }
        
        /* Mobile Day Height - COMPACT */
        @media (max-width: 768px) { 
            .cal-day { min-height: 80px; } /* Default small */
            .grid-view.month .cal-day { min-height: 60px; } /* Month view even smaller */
        }

        .cal-day.today { border-color: var(--accent); box-shadow: inset 0 0 0 1px var(--accent); }
        
        .day-header { font-size: 11px; color: var(--text-med); font-weight: 600; padding-bottom: 4px; border-bottom: 1px solid var(--border); margin-bottom: 2px; display: flex; justify-content: center; text-align: center; }
        @media (max-width: 768px) { 
            .day-header { font-size: 9px; padding-bottom: 2px; margin-bottom: 1px; }
            .day-header span:first-child { display: none; } /* Hide day name */
        }

        /* --- CARDS --- */
        /* Desktop Full Card */
        .card-full {
            background: var(--bg-body); border: 1px solid var(--border); border-radius: 6px; 
            padding: 8px; display: flex; flex-direction: column; gap: 4px; 
            cursor: pointer; position: relative; overflow: hidden; 
            height: 140px; justify-content: space-between;
        }
        .card-full .strip { position: absolute; left: 0; top: 0; bottom: 0; width: 3px; }
        
        .cf-top { display: flex; align-items: center; gap: 8px; }
        .cf-logo { width: 28px; height: 28px; border-radius: 50%; background: #fff; padding: 2px; object-fit: contain; border: 1px solid var(--border); }
        .cf-sym { font-weight: 700; font-size: 14px; font-family: var(--font-num); color: var(--text-high); }
        .star-pos { margin-right: auto; font-size: 14px; cursor: pointer; padding: 4px; }
        .cf-name { font-size: 10px; color: var(--text-med); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
        .cf-footer { display: flex; align-items: center; justify-content: space-between; border-top: 1px solid var(--bg-elevated); padding-top: 4px; margin-top: auto; }
        .cap-badge { font-size: 10px; padding: 1px 4px; border-radius: 4px; background: var(--bg-elevated); color: var(--text-high); border: 1px solid var(--border); font-family: var(--font-num); }
        .sector-text { font-size: 10px; }
        .card-links { display: flex; gap: 6px; opacity: 0.6; }
        .card-link-icon { width: 12px; height: 12px; filter: grayscale(1); }

        /* --- MOBILE CARD OVERRIDE (MICRO VIEW) --- */
        @media (max-width: 768px) {
            /* Transform full cards in grid to micro cards */
            .grid-view:not(.list) .card-full {
                height: auto !important;
                min-height: 36px !important;
                padding: 2px !important;
                gap: 1px !important;
                background: var(--bg-elevated);
                border: 1px solid var(--border);
                align-items: center;
                justify-content: center;
            }
            
            /* Hide details */
            .grid-view:not(.list) .cf-name, 
            .grid-view:not(.list) .cf-footer, 
            .grid-view:not(.list) .star-pos,
            .grid-view:not(.list) .strip { display: none !important; }
            
            /* Stack layout */
            .grid-view:not(.list) .cf-top { 
                flex-direction: column; 
                gap: 1px; 
                width: 100%; 
                margin: 0;
            }
            .grid-view:not(.list) .cf-logo { 
                width: 16px; height: 16px; border: none; padding: 0;
            }
            .grid-view:not(.list) .cf-sym { 
                font-size: 9px; line-height: 1; text-align: center;
            }
        }

        .card-mini { background: var(--bg-body); border: 1px solid var(--border); border-radius: 4px; padding: 4px; display: flex; align-items: center; gap: 4px; cursor: pointer; position: relative; font-size: 10px; margin-bottom: 2px; }
        .card-mini .strip { position: absolute; left: 0; top: 0; bottom: 0; width: 3px; }
        .cm-logo { width: 14px; height: 14px; border-radius: 50%; background: #fff; }
        .cm-sym { font-size: 10px; font-weight: 700; flex: 1; font-family: var(--font-num); }
        
        @media (max-width: 768px) {
            .card-mini { flex-direction: column; padding: 1px; gap: 1px; border: none; background: transparent; }
            .card-mini .strip { display: none; }
            .cm-sym { font-size: 8px; text-align: center; } 
            .cm-logo { width: 14px; height: 14px; } 
            .cm-time { display: none; }
        }

        .more-btn { background: var(--bg-elevated); color: var(--text-med); font-size: 9px; text-align: center; padding: 1px; border-radius: 3px; margin-top: auto; cursor: pointer; }
        .more-card { background: var(--bg-elevated); border: 1px dashed var(--border); border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; color: var(--text-med); height: 100px; }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-overlay.open { display: flex; animation: fadeIn 0.2s ease-out; }
        
        .fin-modal { background: var(--bg-body); width: 95%; max-width: 1300px; height: 90vh; border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
        
        @media (max-width: 900px) {
            .fin-modal { width: 100%; height: 100dvh; border-radius: 0; border: none; }
            .fm-body { display: flex; flex-direction: column; gap: 15px; padding: 10px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
            .fm-sidebar { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; flex-shrink: 0; }
            .charts-split { display: flex; flex-direction: column; gap: 15px; flex-shrink: 0; }
            .chart-box { height: 220px; flex-shrink: 0; }
            .table-wrap { flex-shrink: 0; margin-bottom: 30px; }
        }

        .fm-header { padding: 10px 15px; border-bottom: 1px solid var(--border); background: var(--bg-surface); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        @media (min-width: 901px) {
            .fm-body { display: grid; grid-template-columns: 240px 1fr; gap: 20px; padding: 20px; overflow-y: auto; }
            .fm-sidebar { display: flex; flex-direction: column; gap: 10px; }
            .charts-split { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; height: 320px; }
        }

        .day-modal { background: var(--bg-body); width: 90%; max-width: 600px; height: 80vh; border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
        .day-body { flex: 1; padding: 15px; overflow-y: auto; }
        /* Reset cards inside Day Modal on mobile to look normal list-style */
        .day-body .card-full { height: 120px !important; flex-direction: column !important; justify-content: space-between !important; align-items: stretch !important; padding: 8px !important; background: var(--bg-body) !important; border: 1px solid var(--border) !important; }
        .day-body .card-full .cf-top { flex-direction: row !important; width: auto !important; justify-content: flex-start !important; }
        .day-body .card-full .cf-logo { width: 28px !important; height: 28px !important; }
        .day-body .card-full .cf-sym { font-size: 14px !important; text-align: left !important; }
        .day-body .card-full .cf-name, .day-body .card-full .cf-footer, .day-body .card-full .strip, .day-body .card-full .star-pos { display: flex !important; }

        .kpi-tile { background: var(--bg-surface); border: 1px solid var(--border); padding: 8px; border-radius: 6px; display: flex; flex-direction: column; justify-content: center; min-height: 60px; }
        .kpi-head { font-size: 10px; color: var(--text-med); text-transform: uppercase; margin-bottom: 2px; font-weight: 700; }
        .kpi-num { font-size: 14px; font-weight: 600; color: var(--text-high); font-family: var(--font-num); }
        
        .chart-box { background: var(--bg-surface); border: 1px solid var(--border); border-radius: 8px; padding: 10px; display: flex; flex-direction: column; }
        .chart-title { font-size: 11px; font-weight: 700; color: var(--text-med); text-transform: uppercase; display: flex; justify-content: space-between; margin-bottom: 5px; }
        .chart-wrap { flex: 1; min-height: 0; position: relative; }

        .table-wrap { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; margin-top: auto; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 12px; font-family: var(--font-num); min-width: 500px; }
        .data-table th { text-align: right; background: var(--bg-elevated); color: var(--text-med); padding: 8px; border-bottom: 1px solid var(--border); font-weight: 600; }
        .data-table td { padding: 8px; border-bottom: 1px solid var(--border); color: var(--text-high); text-align: right; }
        
        .list-header { font-size: 14px; color: var(--accent); margin: 15px 0 10px 0; border-bottom: 1px solid var(--border); padding-bottom: 5px; font-family: var(--font-num); }
        .cards-flex { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        
        .suggestions-box { position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-surface); border: 1px solid var(--border); border-radius: 6px; margin-top: 5px; max-height: 250px; overflow-y: auto; z-index: 200; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: none; }
        .suggestions-box.active { display: block; }
        .s-item { padding: 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        
        .c-blue { color: var(--accent); } .c-gold { color: var(--warning); } .c-green { color: var(--success); }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<header>
    <div class="top-bar">
        <div class="logo">Earnings<span>Pro</span></div>
        <div class="controls-group">
            <button class="icon-btn" onclick="toggleTheme()">üåó</button>
            <button class="icon-btn eng-font" onclick="toggleLang()" id="langBtn" style="font-weight:700; font-size:12px;">EN</button>
        </div>
    </div>

    <div class="nav-row">
        <div class="date-controls">
            <button class="nav-arrow" onclick="changeDate(-1)">&#10094;</button>
            <div id="dateDisplay" class="current-date">-</div>
            <button class="nav-arrow" onclick="changeDate(1)">&#10095;</button>
        </div>
        <div class="view-switch">
            <button class="v-btn active" onclick="switchView('list')" id="btn-list" data-i18n="list">◊®◊©◊ô◊û◊î</button>
            <button class="v-btn" onclick="switchView('week')" id="btn-week" data-i18n="week">◊©◊ë◊ï◊¢◊ô</button>
            <button class="v-btn" onclick="switchView('month')" id="btn-month" data-i18n="month">◊ó◊ï◊ì◊©◊ô</button>
        </div>
    </div>

    <div class="action-bar">
        <div class="search-wrap">
            <input type="text" id="searchInput" class="search-input" placeholder="◊ó◊§◊© ◊û◊†◊ô◊î..." data-i18n-ph="search" autocomplete="off">
            <div id="searchSuggestions" class="suggestions-box"></div>
        </div>
        <button class="btn-ui" id="favBtn" onclick="toggleFavFilter()"><span style="color:var(--warning)">‚òÖ</span> <span data-i18n="favorites">◊û◊ï◊¢◊ì◊§◊ô◊ù</span></button>
        <button class="btn-ui" onclick="document.querySelector('.filter-panel').classList.toggle('show')"><span>‚ö°</span> <span data-i18n="filters">◊°◊ô◊†◊ï◊ü</span></button>
    </div>

    <div class="filter-panel">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <div class="f-label" data-i18n="sectors">◊°◊ß◊ò◊ï◊®◊ô◊ù</div>
                <div class="chip-container" id="sectorChips"></div>
            </div>
            <div>
                <div class="f-label" data-i18n="indices">◊û◊ì◊ì◊ô◊ù</div>
                <div class="chip-container">
                    <div class="filter-chip" onclick="toggleChip(this, 'indices', 'sp500')">S&P 500</div>
                    <div class="filter-chip" onclick="toggleChip(this, 'indices', 'nasdaq100')">Nasdaq 100</div>
                </div>
                <div style="margin-top:20px;">
                    <div class="f-label" style="display:flex; justify-content:space-between;"><span data-i18n="marketCap">◊©◊ï◊ï◊ô ◊©◊ï◊ß</span><span id="sliderVal" class="eng-font">-</span></div>
                    <div class="slider-wrap"><div id="capSlider"></div></div>
                </div>
            </div>
        </div>
        <div id="statsBar" style="margin-top:15px; font-size:12px; color:var(--text-med);"></div>
    </div>
</header>

<div class="container" id="mainContainer">
    <div style="text-align:center; padding:50px; color:var(--text-low);">Loading...</div>
</div>

<div class="modal-overlay" id="finModal" onclick="closeModal('finModal')">
    <div class="fin-modal" onclick="event.stopPropagation()">
        <div class="fm-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <img id="mLogo" src="" style="width:36px; height:36px; border-radius:50%; background:#fff;">
                <div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <h2 id="mSymbol" class="eng-font" style="margin:0; font-size:20px;">-</h2>
                        <span id="mSector" style="font-size:10px; background:var(--bg-body); padding:2px 6px; border-radius:4px; border:1px solid var(--border);">-</span>
                    </div>
                    <div id="mName" style="font-size:12px; color:var(--text-med);">-</div>
                </div>
            </div>
            <span style="font-size:24px; cursor:pointer;" onclick="closeModal('finModal')">‚úï</span>
        </div>
        <div class="fm-body">
            <div class="fm-sidebar">
                <div class="kpi-tile"><div class="kpi-head" data-i18n="marketCap">Market Cap</div><div class="kpi-num" id="mCap">-</div></div>
                <div class="kpi-tile"><div class="kpi-head">P/E (LTM)</div><div class="kpi-num" id="mPE">-</div></div>
                <div class="kpi-tile"><div class="kpi-head" data-i18n="revenue">Revenue</div><div class="kpi-num c-blue" id="mRev">-</div></div>
                <div class="kpi-tile"><div class="kpi-head" data-i18n="dividend">Dividend</div><div class="kpi-num" id="mDiv">-</div></div>
                <div class="kpi-tile"><div class="kpi-head" data-i18n="ROE">ROE</div><div class="kpi-num" id="mROE">-</div></div>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <a id="lnkYahoo" href="#" target="_blank" class="btn-ui" style="flex:1; justify-content:center;">Yahoo</a>
                    <a id="lnkTV" href="#" target="_blank" class="btn-ui" style="flex:1; justify-content:center;">TV</a>
                </div>
            </div>
            <div class="fm-main">
                <div class="charts-split">
                    <div class="chart-box"><div class="chart-title"><span data-i18n="income">INCOME</span> <span><span class="c-blue">‚óè Rev</span> <span class="c-gold">‚óè Net</span></span></div><div class="chart-wrap"><canvas id="incomeChart"></canvas></div></div>
                    <div class="chart-box"><div class="chart-title"><span data-i18n="efficiency">EFFICIENCY</span> <span><span class="c-green">‚óè FCF</span> <span style="color:var(--purple)">‚óè Margin</span></span></div><div class="chart-wrap"><canvas id="ratioChart"></canvas></div></div>
                </div>
                <div id="mAnalysis" style="font-size:13px; color:var(--text-high); padding:10px; background:var(--bg-elevated); border-radius:6px;"></div>
                <div class="table-wrap">
                    <table class="data-table" id="mTable"><thead><tr><th data-i18n="date">Date</th><th data-i18n="revenue">Revenue</th><th data-i18n="netIncome">Net Income</th><th data-i18n="margin">Margin</th><th>FCF</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="dayModal" onclick="closeModal('dayModal')">
    <div class="day-modal" onclick="event.stopPropagation()">
        <div class="fm-header">
            <h2 id="dayTitle" class="eng-font" style="margin:0; font-size:18px;">-</h2>
            <span style="font-size:24px; cursor:pointer;" onclick="closeModal('dayModal')">‚úï</span>
        </div>
        <div class="day-body">
            <div class="cards-flex" id="dayGrid"></div>
        </div>
    </div>
</div>

<script>
    const dict = {
        list: { he: '◊®◊©◊ô◊û◊î', en: 'List' }, week: { he: '◊©◊ë◊ï◊¢◊ô', en: 'Week' }, month: { he: '◊ó◊ï◊ì◊©◊ô', en: 'Month' }, search: { he: '◊ó◊§◊© ◊û◊†◊ô◊î...', en: 'Search Ticker...' }, favorites: { he: '◊û◊ï◊¢◊ì◊§◊ô◊ù', en: 'Favorites' }, filters: { he: '◊°◊ô◊†◊ï◊ü', en: 'Filters' }, sectors: { he: '◊°◊ß◊ò◊ï◊®◊ô◊ù', en: 'Sectors' }, indices: { he: '◊û◊ì◊ì◊ô◊ù', en: 'Indices' }, marketCap: { he: '◊©◊ï◊ï◊ô ◊©◊ï◊ß', en: 'Market Cap' }, revenue: { he: '◊î◊õ◊†◊°◊ï◊™', en: 'Revenue' }, netIncome: { he: '◊®◊ï◊ï◊ó ◊†◊ß◊ô', en: 'Net Income' }, dividend: { he: '◊ì◊ô◊ë◊ô◊ì◊†◊ì', en: 'Dividend' }, income: { he: '◊ì◊ï◊ó ◊®◊ï◊ï◊ó ◊ï◊î◊§◊°◊ì', en: 'INCOME STATEMENT' }, efficiency: { he: '◊ô◊¢◊ô◊ú◊ï◊™ ◊ï◊™◊ñ◊®◊ô◊ù', en: 'EFFICIENCY & FLOW' }, date: { he: '◊™◊ê◊®◊ô◊ö', en: 'Date' }, margin: { he: '◊©◊ï◊ú◊ô ◊®◊ï◊ï◊ó', en: 'Margin' }, results: { he: '◊†◊û◊¶◊ê◊ï %s ◊û◊†◊ô◊ï◊™', en: '%s Results Found' }, growth: { he: '◊¶◊û◊ô◊ó◊î ◊©◊†◊™◊ô◊™', en: 'YoY Growth' },
        showAll: { he: '◊î◊¶◊í ◊î◊õ◊ú', en: 'Show All' }, ROE: { he: '◊™◊©◊ï◊ê◊î ◊ú◊î◊ï◊ü', en: 'ROE' }
    };
    const sectorDict = { "Technology": "◊ò◊õ◊†◊ï◊ú◊ï◊í◊ô◊î", "Financial Services": "◊§◊ô◊†◊†◊°◊ô◊ù", "Healthcare": "◊ë◊®◊ô◊ê◊ï◊™", "Consumer Cyclical": "◊¶◊®◊õ◊†◊ï◊™ ◊û◊ó◊ñ◊ï◊®◊ô◊™", "Industrials": "◊™◊¢◊©◊ô◊ô◊î", "Communication Services": "◊™◊ß◊©◊ï◊®◊™", "Consumer Defensive": "◊¶◊®◊õ◊†◊ï◊™ ◊ë◊°◊ô◊°◊ô◊™", "Energy": "◊ê◊†◊®◊í◊ô◊î", "Basic Materials": "◊ó◊ï◊û◊®◊ô ◊í◊ú◊ù", "Real Estate": "◊†◊ì◊ú\"◊ü", "Utilities": "◊™◊©◊™◊ô◊ï◊™", "ETF": "◊™◊¢◊ï◊ì◊™ ◊°◊ú", "Unknown": "◊ê◊ó◊®" };
    let currentLang = 'he';

    const $ = (id) => document.getElementById(id);
    const setText = (id, val) => { const el = $(id); if(el) el.innerText = (val!=null) ? val : "-"; }
    const getProp = (obj, key, fb='') => (obj && obj[key]!=null) ? obj[key] : fb;
    const formatNum = (n) => { if(!n) return "-"; if(n>=1e12) return (n/1e12).toFixed(2)+"T"; if(n>=1e9) return (n/1e9).toFixed(2)+"B"; if(n>=1e6) return (n/1e6).toFixed(2)+"M"; return n.toLocaleString(); };
    function toISODate(d) { return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0'); }
    function getSectorName(sec) { return currentLang === 'en' ? sec : (sectorDict[sec] || sec); }

    let allData = [], historyData = {};
    let currentView = 'week';
    let navDate = new Date();
    let filters = { sectors: new Set(), indices: new Set(), minCap: 1e9, maxCap: 5e12, favOnly: false };
    let favorites = new Set(JSON.parse(localStorage.getItem('favStocks') || '[]'));
    let chart1 = null, chart2 = null;

    document.addEventListener('DOMContentLoaded', async () => {
        const buster = Date.now();
        try {
            const r1 = await fetch(`./data.json?v=${buster}`);
            allData = (await r1.json()).filter(d => d.earningsDate && d.earningsDate !== '?' && d.earningsDate !== 'TBD');
            fetch(`./history_data.json?v=${buster}`).then(r=>r.json()).then(h=>{ historyData=h; }).catch(console.error);
            initSectorChips(); initSlider(); updateUI();
        } catch(e) { $('mainContainer').innerHTML = `<div style="text-align:center; color:var(--danger)">Error: ${e.message}</div>`; }
    });

    function toggleTheme() { const root = document.documentElement; root.setAttribute('data-theme', root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }
    function toggleLang() { currentLang = currentLang === 'he' ? 'en' : 'he'; document.documentElement.dir = currentLang === 'he' ? 'rtl' : 'ltr'; $('langBtn').innerText = currentLang === 'he' ? 'EN' : 'HE'; updateStaticTranslations(); initSectorChips(); updateUI(); }
    function updateStaticTranslations() { document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if(dict[key]) el.innerText = dict[key][currentLang]; }); const search = $('searchInput'); if(search) search.placeholder = dict.search[currentLang]; }

    function initSectorChips() { const rawSectors = [...new Set(allData.map(d => d.sector || 'Other'))].sort(); const container = $('sectorChips'); container.innerHTML = ''; rawSectors.forEach(rawSec => { const translated = getSectorName(rawSec); const chip = document.createElement('div'); chip.className = 'filter-chip'; chip.innerText = translated; if(filters.sectors.has(rawSec)) chip.classList.add('selected'); chip.onclick = () => toggleChip(chip, 'sectors', rawSec); container.appendChild(chip); }); }
    function initSlider() { const s = $('capSlider'); noUiSlider.create(s, { start: [1e9, 5e12], connect: true, range: { 'min': 1e9, '30%': 50e9, '70%': 200e9, 'max': 5e12 } }); s.noUiSlider.on('update', (vals) => { filters.minCap = parseFloat(vals[0]); filters.maxCap = parseFloat(vals[1]); setText('sliderVal', `$${formatNum(filters.minCap)} - $${formatNum(filters.maxCap)}`); updateUI(); }); }

    function toggleChip(el, type, val) { if(filters[type].has(val)) { filters[type].delete(val); el.classList.remove('selected'); } else { filters[type].add(val); el.classList.add('selected'); } updateUI(); }
    function toggleFavFilter() { filters.favOnly = !filters.favOnly; $('favBtn').classList.toggle('active'); updateUI(); }

    const searchInput = $('searchInput');
    const suggestionsBox = $('searchSuggestions');
    searchInput.addEventListener('input', (e) => {
        const val = e.target.value.toLowerCase().trim();
        if(val.length < 1) { suggestionsBox.style.display = 'none'; updateUI(); return; }
        const matches = allData.filter(d => d.symbol.toLowerCase().startsWith(val) || d.name.toLowerCase().includes(val)).sort((a,b) => {
            const sA = a.symbol.toLowerCase(); const sB = b.symbol.toLowerCase();
            if(sA === val) return -1; if(sB === val) return 1;
            if(sA.startsWith(val) && !sB.startsWith(val)) return -1; if(!sA.startsWith(val) && sB.startsWith(val)) return 1; return 0;
        }).slice(0, 10);
        if(matches.length > 0) {
            suggestionsBox.innerHTML = '';
            matches.forEach(s => {
                const item = document.createElement('div'); item.className = 's-item';
                item.innerHTML = `<div class="s-left"><span class="s-sym">${s.symbol}</span><span class="s-name">${s.name}</span></div><span class="s-date">${s.earningsDate}</span>`;
                item.onclick = () => { navDate = new Date(s.earningsDate); openModal(s); searchInput.value = ''; suggestionsBox.style.display = 'none'; updateUI(); };
                suggestionsBox.appendChild(item);
            });
            suggestionsBox.style.display = 'block';
        } else { suggestionsBox.style.display = 'none'; }
    });
    document.addEventListener('click', (e) => { if(!e.target.closest('.search-wrap')) suggestionsBox.style.display = 'none'; });

    function updateUI() {
        const q = searchInput.value.toLowerCase().trim();
        const filtered = allData.filter(d => {
            const mCap = getProp(d, 'marketCap', 0);
            const matchesCap = mCap >= filters.minCap && mCap <= filters.maxCap;
            const matchesSearch = !q || d.symbol.toLowerCase().includes(q) || d.name.toLowerCase().includes(q);
            const matchesSec = filters.sectors.size === 0 || filters.sectors.has(d.sector);
            let matchesIdx = true;
            if(filters.indices.size > 0) { matchesIdx = false; if(filters.indices.has('sp500') && d.inSp500) matchesIdx = true; if(filters.indices.has('nasdaq100') && d.inNasdaq100) matchesIdx = true; }
            const matchesFav = !filters.favOnly || favorites.has(d.symbol);
            return matchesCap && matchesSearch && matchesSec && matchesIdx && matchesFav;
        });
        filtered.sort((a, b) => new Date(a.earningsDate) - new Date(b.earningsDate));
        const countStr = dict.results[currentLang].replace('%s', filtered.length); setText('statsBar', countStr);
        const container = $('mainContainer'); container.innerHTML = '';
        if(currentView === 'list') renderList(container, filtered); else if(currentView === 'week') renderWeek(container, filtered); else renderMonth(container, filtered);
        updateDateDisplay();
    }

    function renderWeek(container, data) {
        container.className = 'grid-view week';
        const day = navDate.getDay(); const start = new Date(navDate); start.setDate(navDate.getDate() - day);
        for(let i=0; i<7; i++) {
            const d = new Date(start); d.setDate(start.getDate() + i); const dateStr = toISODate(d);
            const col = document.createElement('div'); col.className = 'cal-day'; if(dateStr === toISODate(new Date())) col.classList.add('today');
            const dayName = d.toLocaleDateString(currentLang==='he'?'he-IL':'en-US', {weekday:'short'});
            col.innerHTML = `<div class="day-header"><span>${dayName}</span> <span class="eng-font">${d.getDate()}/${d.getMonth()+1}</span></div>`;
            const daily = data.filter(s => s.earningsDate === dateStr).sort((a,b)=>b.marketCap-a.marketCap);
            daily.forEach(s => col.appendChild(createCard(s, 'full'))); container.appendChild(col);
        }
    }

    function renderMonth(container, data) {
        container.className = 'grid-view month';
        const year = navDate.getFullYear(), month = navDate.getMonth(); const days = new Date(year, month + 1, 0).getDate();
        for(let i=1; i<=days; i++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const cell = document.createElement('div'); cell.className = 'cal-day'; cell.innerHTML = `<div class="day-header">${i}</div>`;
            const daily = data.filter(s => s.earningsDate === dateStr).sort((a,b)=>b.marketCap-a.marketCap);
            
            // --- Mobile Limit Month View ---
            // On mobile we only show 1 item + more button to save vertical space
            const isMobile = window.innerWidth <= 768;
            const limit = isMobile ? 1 : 4;
            
            daily.slice(0, limit).forEach(s => cell.appendChild(createCard(s, 'mini')));
            if(daily.length > limit) {
                const more = document.createElement('div'); more.className = 'more-btn';
                more.innerText = `+${daily.length-limit}`;
                more.onclick = (e) => { e.stopPropagation(); openDayModal(dateStr, daily); };
                cell.appendChild(more);
            }
            container.appendChild(cell);
        }
    }

    function renderList(container, data) {
        container.className = 'grid-view list';
        const start = new Date(navDate); start.setHours(0,0,0,0); const end = new Date(start); end.setDate(end.getDate() + 30);
        const subset = data.filter(d => { const dt = new Date(d.earningsDate); return dt >= start && dt < end; });
        if(subset.length === 0) { container.innerHTML = '<div style="text-align:center; padding:40px;">No Earnings</div>'; return; }
        const grouped = {}; subset.forEach(s => { if(!grouped[s.earningsDate]) grouped[s.earningsDate]=[]; grouped[s.earningsDate].push(s); });
        Object.keys(grouped).sort().forEach(date => {
            const dObj = new Date(date);
            const header = document.createElement('div'); header.className='list-header';
            header.innerText = `${date} / ${dObj.toLocaleDateString(currentLang==='he'?'he-IL':'en-US', {weekday:'long'})}`;
            container.appendChild(header);
            const grid = document.createElement('div'); grid.className='cards-flex';
            const stocks = grouped[date].sort((a,b)=>b.marketCap-a.marketCap);
            const limit = 12;
            stocks.slice(0, limit).forEach(s => grid.appendChild(createCard(s, 'full')));
            if(stocks.length > limit) {
                const moreCard = document.createElement('div'); moreCard.className = 'more-card';
                moreCard.innerHTML = `<div class="eng-font" style="font-size:24px; font-weight:700;">+${stocks.length - limit}</div><div style="font-size:12px;">${dict.showAll[currentLang]}</div>`;
                moreCard.onclick = () => openDayModal(date, stocks);
                grid.appendChild(moreCard);
            }
            container.appendChild(grid);
        });
    }

    function createCard(s, type='full') {
        const el = document.createElement('div');
        const sector = getSectorName(s.sector || 'Unknown');
        let stripColor = 'var(--text-low)';
        if(s.sector && s.sector.includes('Tech')) stripColor = 'var(--accent)'; if(s.sector && s.sector.includes('Fin')) stripColor = 'var(--success)'; if(s.sector && s.sector.includes('Health')) stripColor = 'var(--danger)';
        let timeIcon = ''; const t = (s.time || '').toLowerCase(); if(t.includes('after') || t.includes('close')) timeIcon = 'üåô'; else if(t.includes('before') || t.includes('open')) timeIcon = '‚òÄÔ∏è';
        const isFav = favorites.has(s.symbol); const starColor = isFav ? 'var(--warning)' : 'var(--border)';

        if(type === 'full') {
            el.className = 'card-full'; el.innerHTML = `
                <div class="strip" style="background:${stripColor}"></div>
                <div class="cf-top"><img src="https://assets.parqet.com/logos/symbol/${s.symbol}?format=png" class="cf-logo" onerror="this.style.opacity=0"><span class="cf-sym">${s.symbol}</span><div class="star-pos" style="color:${starColor}" onclick="toggleFav(event, '${s.symbol}')">‚òÖ</div></div>
                <div class="cf-name">${s.name}</div>
                <div class="cf-footer"><div class="capsule"><span class="cap-badge">$${formatNum(s.marketCap)}</span><span class="sector-text">${timeIcon}</span></div><div class="card-links"><a href="https://finance.yahoo.com/quote/${s.symbol}" target="_blank" onclick="event.stopPropagation()"><img src="https://www.google.com/s2/favicons?domain=finance.yahoo.com" class="card-link-icon"></a><a href="https://www.tradingview.com/chart/?symbol=${s.symbol}" target="_blank" onclick="event.stopPropagation()"><img src="https://www.google.com/s2/favicons?domain=tradingview.com" class="card-link-icon"></a></div></div>`;
        } else {
            el.className = 'card-mini'; el.style.borderLeft = `3px solid ${stripColor}`; el.innerHTML = `<img src="https://assets.parqet.com/logos/symbol/${s.symbol}?format=png" class="cm-logo" onerror="this.style.opacity=0"><span class="cm-sym eng-font">${s.symbol}</span><span class="cm-time">${timeIcon}</span><a href="https://finance.yahoo.com/quote/${s.symbol}" target="_blank" onclick="event.stopPropagation()" style="opacity:0.5"><img src="https://www.google.com/s2/favicons?domain=finance.yahoo.com" style="width:10px"></a>`;
        }
        el.onclick = () => openModal(s); return el;
    }

    function toggleFav(e, sym) { 
        e.stopPropagation(); 
        if(favorites.has(sym)) favorites.delete(sym); else favorites.add(sym); 
        localStorage.setItem('favStocks', JSON.stringify([...favorites])); 
        e.target.style.color = favorites.has(sym) ? 'var(--warning)' : 'var(--border)';
        updateUI(); 
    }

    function openModal(s) {
        setText('mSymbol', s.symbol); setText('mName', s.name); setText('mSector', getSectorName(s.sector || 'Unknown'));
        $('mLogo').src = `https://assets.parqet.com/logos/symbol/${s.symbol}?format=png`;
        setText('mCap', formatNum(s.marketCap)); setText('mPE', getProp(s, 'trailingPE') ? s.trailingPE.toFixed(2) : "-"); setText('mRev', formatNum(s.revenue)); setText('mDiv', getProp(s, 'dividendYield') ? (s.dividendYield*100).toFixed(2)+"%" : "-"); setText('mROE', getProp(s, 'returnOnEquity') ? (s.returnOnEquity*100).toFixed(1)+"%" : "-");
        $('lnkYahoo').href = `https://finance.yahoo.com/quote/${s.symbol}`; $('lnkTV').href = `https://www.tradingview.com/chart/?symbol=${s.symbol}`;
        const hist = historyData[s.symbol]; const tbody = $('mTable').querySelector('tbody'); tbody.innerHTML = '';
        if(hist && hist.quarterlyHistory) {
            const dates = hist.quarterlyHistory.map(h=>h.date).reverse(); const rev = hist.quarterlyHistory.map(h=>h.revenue).reverse(); const net = hist.quarterlyHistory.map(h=>h.netIncome).reverse(); const fcf = hist.quarterlyHistory.map(h=>h.freeCashFlow).reverse(); const margin = hist.quarterlyHistory.map(h=>h.margin).reverse();
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark'; const gridColor = isDark ? '#333' : '#eee'; const textColor = isDark ? '#888' : '#555';
            const ctx1 = $('incomeChart').getContext('2d'); if(chart1) chart1.destroy(); chart1 = new Chart(ctx1, { type: 'bar', data: { labels: dates, datasets: [{ label: 'Rev', data: rev, backgroundColor: '#3b82f6' }, { label: 'Net', data: net, backgroundColor: '#f59e0b' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: {display:false}, ticks:{color:textColor} }, y: { grid: {color:gridColor}, ticks:{color:textColor, callback:formatNum} } }, plugins: { legend: {display:false} } } });
            const ctx2 = $('ratioChart').getContext('2d'); if(chart2) chart2.destroy(); chart2 = new Chart(ctx2, { type: 'bar', data: { labels: dates, datasets: [{ label: 'FCF', data: fcf, backgroundColor: 'rgba(16, 185, 129, 0.6)', borderColor: '#10b981', borderWidth:1 }, { label: 'Margin %', data: margin, type:'line', borderColor: '#8b5cf6', yAxisID:'y1' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: {display:false}, ticks:{color:textColor} }, y: { grid: {color:gridColor}, ticks:{color:textColor, callback:formatNum} }, y1: { position: 'right', grid: {display:false}, ticks:{color:'#8b5cf6'} } }, plugins: { legend: {display:false} } } });
            hist.quarterlyHistory.forEach(q => { const tr = document.createElement('tr'); tr.innerHTML = `<td class="eng-font" style="color:var(--text-med)">${q.date}</td><td class="eng-font c-blue">${formatNum(q.revenue)}</td><td class="eng-font c-gold">${formatNum(q.netIncome)}</td><td class="eng-font">${q.margin}%</td><td class="eng-font c-green">${formatNum(q.freeCashFlow)}</td>`; tbody.appendChild(tr); });
            $('mAnalysis').innerHTML = `${dict.growth[currentLang]}: <strong style="color:${hist.yoyRevenueGrowth>0?'var(--success)':'var(--danger)'}">${hist.yoyRevenueGrowth}%</strong>`;
        } else { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No History</td></tr>'; if(chart1) chart1.destroy(); if(chart2) chart2.destroy(); $('mAnalysis').innerText = '-'; }
        $('finModal').classList.add('open');
    }

    function openDayModal(dateStr, stocks) {
        setText('dayTitle', dateStr);
        const grid = $('dayGrid'); grid.innerHTML = '';
        stocks.forEach(s => grid.appendChild(createCard(s, 'full')));
        $('dayModal').classList.add('open');
    }

    function closeModal(id) { $(id).classList.remove('open'); }

    function changeDate(d) { if(currentView === 'month') navDate.setMonth(navDate.getMonth() + d); else navDate.setDate(navDate.getDate() + (d * 7)); updateDateDisplay(); updateUI(); }
    function switchView(v) { currentView = v; document.querySelectorAll('.v-btn').forEach(b => b.classList.remove('active')); $(`btn-${v}`).classList.add('active'); updateDateDisplay(); updateUI(); }
    function updateDateDisplay() { const opts = { month: 'long', year: 'numeric' }; if(currentView === 'month') { $('dateDisplay').innerText = navDate.toLocaleDateString(currentLang==='he'?'he-IL':'en-US', opts); } else { const d = new Date(navDate); const day = d.getDay(); const start = new Date(d); start.setDate(d.getDate() - day); const end = new Date(start); end.setDate(start.getDate() + 6); $('dateDisplay').innerText = `${start.getDate()}/${start.getMonth()+1} - ${end.getDate()}/${end.getMonth()+1}`; } }

    $('searchInput').addEventListener('keyup', updateUI);
</script>
</body>
</html>
