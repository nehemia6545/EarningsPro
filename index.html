<!DOCTYPE html>
<html lang="he" dir="rtl" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Earnings Pro - Visuals</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <style>
        :root {
            --bg-color: #0f1115; --card-bg: #1e222d; --panel-bg: #131722;
            --text-main: #e0e0e0; --text-muted: #94a3b8;
            --accent-blue: #3b82f6; --accent-gold: #f59e0b; 
            --accent-green: #10b981; --accent-red: #ef4444;
            --border-color: #334155; --shadow: 0 4px 20px rgba(0,0,0,0.4);
            --modal-bg: rgba(0, 0, 0, 0.85);
            --chart-grid: #334155;
        }
        [data-theme="light"] {
            --bg-color: #f1f5f9; --card-bg: #ffffff; --panel-bg: #f8fafc;
            --text-main: #0f172a; --text-muted: #64748b;
            --accent-blue: #2563eb; --accent-gold: #d97706; 
            --accent-green: #059669; --accent-red: #dc2626;
            --border-color: #e2e8f0; --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --modal-bg: rgba(0, 0, 0, 0.6);
            --chart-grid: #e2e8f0;
        }
        
        * { box-sizing: border-box; }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Rubik', sans-serif; margin: 0; padding: 0; overflow-y: scroll; -webkit-tap-highlight-color: transparent; }
        
        /* HEADER */
        header { 
            background-color: var(--card-bg); border-bottom: 1px solid var(--border-color); 
            padding: 15px 20px; position: sticky; top: 0; z-index: 1000; box-shadow: var(--shadow); 
        }
        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .logo { font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }
        .logo span { color: var(--accent-blue); }
        
        .date-nav { 
            display: flex; align-items: center; gap: 15px; background: var(--panel-bg); 
            padding: 6px 15px; border-radius: 50px; border: 1px solid var(--border-color); 
        }
        .nav-btn { background: none; border: none; color: var(--text-main); font-size: 18px; cursor: pointer; transition: 0.2s; }
        .nav-btn:hover { color: var(--accent-blue); }
        
        .view-toggle { display: flex; gap: 4px; background: var(--panel-bg); padding: 4px; border-radius: 8px; border: 1px solid var(--border-color); }
        .view-btn { border: none; background: transparent; color: var(--text-muted); padding: 6px 12px; font-size: 13px; font-weight: 500; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .view-btn.active { background: var(--accent-blue); color: white; shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .controls-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        input[type="text"] { 
            background: var(--panel-bg); border: 1px solid var(--border-color); color: var(--text-main); 
            padding: 0 15px; border-radius: 8px; font-size: 14px; height: 40px; outline: none; flex: 1; min-width: 150px;
            transition: 0.2s;
        }
        input[type="text"]:focus { border-color: var(--accent-blue); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }

        .filter-toggle-btn {
            background: var(--panel-bg); border: 1px solid var(--border-color); color: var(--text-main);
            padding: 0 15px; height: 40px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500;
            display: flex; align-items: center; gap: 8px;
        }
        
        /* CARDS GRID */
        .container { max-width: 1800px; margin: 0 auto; padding: 20px; }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; }
        
        .stock-card { 
            background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; 
            padding: 15px; display: flex; flex-direction: column; justify-content: space-between; gap: 10px; 
            position: relative; overflow: hidden; box-shadow: var(--shadow); height: 170px; cursor: pointer; 
            transition: transform 0.2s, border-color 0.2s;
        }
        .stock-card:hover { border-color: var(--accent-blue); transform: translateY(-4px); }
        .card-strip { position: absolute; top: 0; left: 0; width: 100%; height: 4px; }
        
        .card-top { display: flex; align-items: center; gap: 12px; }
        .stock-logo { width: 32px; height: 32px; border-radius: 50%; background: #fff; padding: 2px; object-fit: contain; }
        .symbol { font-size: 16px; font-weight: 700; display: block; }
        .market-cap { font-size: 11px; color: var(--text-muted); background: var(--panel-bg); padding: 2px 6px; border-radius: 4px; }
        .company-name { font-size: 12px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; direction: ltr; text-align: left; }
        
        .card-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: auto; }
        .tag-text { font-size: 10px; padding: 3px 8px; border-radius: 12px; font-weight: 500; }
        
        /* MODAL (Redesigned) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-bg); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-overlay.open { display: flex; animation: fadeIn 0.2s; }
        
        .fin-modal { 
            background: var(--card-bg); width: 95%; max-width: 1000px; height: 92vh; border-radius: 16px; 
            border: 1px solid var(--border-color); display: flex; flex-direction: column; overflow: hidden; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); 
        }
        .fin-header { 
            padding: 15px 25px; border-bottom: 1px solid var(--border-color); background: var(--panel-bg); 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .fin-body { flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 25px; }
        
        /* Modal Sections */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
        .kpi-box { 
            background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 10px; padding: 15px; text-align: center; 
            display: flex; flex-direction: column; justify-content: center;
        }
        .kpi-title { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }
        .kpi-val { font-size: 18px; font-weight: 700; color: var(--text-main); direction: ltr; }
        
        /* Charts Area */
        .charts-wrapper { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .charts-wrapper { grid-template-columns: 1fr; } }
        
        .chart-box { 
            background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 15px; 
            height: 300px; position: relative;
        }
        .chart-title { font-size: 14px; font-weight: 500; margin-bottom: 10px; color: var(--text-muted); display: flex; justify-content: space-between; }

        /* Data Table */
        .table-wrap { overflow-x: auto; border: 1px solid var(--border-color); border-radius: 12px; }
        .hist-table { width: 100%; border-collapse: collapse; font-size: 13px; text-align: right; direction: ltr; }
        .hist-table th { background: var(--panel-bg); color: var(--text-muted); padding: 12px; font-weight: 500; border-bottom: 1px solid var(--border-color); text-align: right; }
        .hist-table td { padding: 12px; border-bottom: 1px solid var(--border-color); color: var(--text-main); }
        .hist-table tr:last-child td { border: none; }
        .hist-table tr:hover { background: rgba(255,255,255,0.02); }

        /* Helpers */
        .val-green { color: var(--accent-green); } .val-red { color: var(--accent-red); }
        .badge { display: inline-block; padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .bg-pass { background: rgba(16, 185, 129, 0.15); color: var(--accent-green); border: 1px solid rgba(16, 185, 129, 0.3); }
        .bg-warn { background: rgba(245, 158, 11, 0.15); color: var(--accent-gold); border: 1px solid rgba(245, 158, 11, 0.3); }
        
        .sec-tech { background: #3b82f6; } .bg-tech { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
        .sec-fin { background: #10b981; } .bg-fin { background: rgba(16, 185, 129, 0.15); color: #10b981; }
        .sec-health { background: #ef4444; } .bg-health { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
        .sec-other { background: #64748b; } .bg-other { background: rgba(100, 116, 139, 0.15); color: #94a3b8; }

        /* Animation */
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        
        /* Advanced Filters & Slider CSS (Hidden by default) */
        .advanced-filters { display: none; margin-top: 10px; background: var(--panel-bg); padding: 15px; border-radius: 12px; border: 1px solid var(--border-color); }
        .advanced-filters.show { display: block; animation: slideD 0.3s; }
        @keyframes slideD { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .slider-section { margin-top: 20px; padding: 0 10px; }
        .noUi-target { background: var(--border-color); border: none; height: 6px; }
        .noUi-connect { background: var(--accent-blue); }
        .slider-presets { display: flex; gap: 8px; margin-top: 15px; flex-wrap: wrap; }
        .preset-chip { font-size: 11px; background: var(--card-bg); border: 1px solid var(--border-color); padding: 5px 12px; border-radius: 20px; cursor: pointer; transition: 0.2s; }
        .preset-chip:hover { border-color: var(--accent-blue); color: var(--accent-blue); }
        
        .multi-select { position: relative; display: inline-block; margin-right: 10px; }
        .ms-btn { background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-main); padding: 8px 30px 8px 12px; border-radius: 8px; cursor: pointer; font-size: 13px; }
        .ms-content { display: none; position: absolute; top: 40px; right: 0; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; width: 220px; max-height: 250px; overflow-y: auto; z-index: 2000; padding: 5px; box-shadow: var(--shadow); }
        .ms-content.show { display: block; }
        .ms-option { display: flex; align-items: center; gap: 10px; padding: 8px; cursor: pointer; border-radius: 6px; }
        .ms-option:hover { background: rgba(255,255,255,0.05); }
    </style>
</head>
<body>

<header>
    <div class="top-row">
        <div class="logo">Earnings<span>Pro</span></div>
        <div class="date-nav">
            <button class="nav-btn" onclick="changeDate(-1)">&#10094;</button>
            <div id="dateDisplay" style="font-weight:500; min-width:140px; text-align:center; direction:ltr;">-</div>
            <button class="nav-btn" onclick="changeDate(1)">&#10095;</button>
        </div>
        <div class="right-actions">
            <button class="theme-btn" onclick="toggleTheme()">ğŸŒ—</button>
            <div class="view-toggle">
                <button class="view-btn active" onclick="switchView('list')" id="btn-list">×¨×©×™××”</button>
                <button class="view-btn" onclick="switchView('month')" id="btn-month">×—×•×“×©×™</button>
            </div>
        </div>
    </div>

    <div class="controls-row">
        <input type="text" id="searchInput" placeholder="×—×¤×© ×× ×™×” ××• ETF...">
        <button class="filter-toggle-btn" onclick="document.querySelector('.advanced-filters').classList.toggle('show')">
            <span>×¡×™× ×•×Ÿ ××ª×§×“×</span> â–¼
        </button>
    </div>

    <div class="advanced-filters">
        <div style="display:flex; flex-wrap:wrap; margin-bottom:15px;">
            <div class="multi-select" id="sectorMS"><button class="ms-btn" onclick="toggleDropdown('sectorMS')">×¡×§×˜×•×¨×™×</button><div class="ms-content" id="sectorOptions"></div></div>
            <div class="multi-select" id="indexMS"><button class="ms-btn" onclick="toggleDropdown('indexMS')">××“×“×™× ×•-ETFs</button>
                <div class="ms-content">
                    <div class="ms-option" onclick="toggleFilter('indices','sp500')"><input type="checkbox" value="sp500"><span>S&P 500</span></div>
                    <div class="ms-option" onclick="toggleFilter('indices','nasdaq100')"><input type="checkbox" value="nasdaq100"><span>Nasdaq 100</span></div>
                    <hr style="border-color:var(--border-color); opacity:0.5; margin:5px 0;">
                    <div class="ms-option" onclick="toggleFilter('indices','vti')"><input type="checkbox" value="vti"><span>VTI (Total Market)</span></div>
                    <div class="ms-option" onclick="toggleFilter('indices','schd')"><input type="checkbox" value="schd"><span>SCHD (Dividend)</span></div>
                    <div class="ms-option" onclick="toggleFilter('indices','vug')"><input type="checkbox" value="vug"><span>VUG (Growth)</span></div>
                </div>
            </div>
        </div>
        <div class="slider-section">
            <div class="slider-header"><span>×©×•×•×™ ×©×•×§</span><span id="sliderValues" class="slider-values">Loading...</span></div>
            <div id="marketCapSlider"></div>
            <div class="slider-presets">
                <div class="preset-chip" onclick="setSliderRange(1000000000, 5000000000000)">×”×›×œ</div>
                <div class="preset-chip" onclick="setSliderRange(1000000000, 20000000000)">Small Cap</div>
                <div class="preset-chip" onclick="setSliderRange(20000000000, 200000000000)">Mid Cap</div>
                <div class="preset-chip" onclick="setSliderRange(200000000000, 5000000000000)">Giants</div>
            </div>
        </div>
        <div id="stats-counter" style="margin-top:10px; font-size:12px; color:var(--text-muted);"></div>
    </div>
</header>

<div class="container" id="main-container">
    <div id="loader" style="text-align: center; padding: 50px; color: var(--text-muted);">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
</div>

<div class="modal-overlay" id="finModal" onclick="closeModal()">
    <div class="fin-modal" onclick="event.stopPropagation()">
        <div class="fin-header">
            <div>
                <h2 style="margin:0; display:flex; align-items:center; gap:10px;">
                    <span id="mSymbol">AAPL</span> 
                    <span id="mSector" class="badge bg-other">Tech</span>
                </h2>
                <span id="mName" style="color:var(--text-muted); font-size:13px;">Apple Inc.</span>
            </div>
            <span style="font-size:24px; cursor:pointer;" onclick="closeModal()">âœ•</span>
        </div>
        
        <div class="fin-body">
            <div class="dashboard-grid">
                <div class="kpi-box"><span class="kpi-title">×©×•×•×™ ×©×•×§</span><span class="kpi-val" id="mCap">-</span></div>
                <div class="kpi-box"><span class="kpi-title">××›×¤×™×œ (P/E)</span><span class="kpi-val" id="mPE">-</span></div>
                <div class="kpi-box"><span class="kpi-title">×”×›× ×¡×•×ª (×©× ×ª×™)</span><span class="kpi-val" id="mRev">-</span></div>
                <div class="kpi-box"><span class="kpi-title">×“×™×‘×™×“× ×“</span><span class="kpi-val" id="mDiv">-</span></div>
                <div class="kpi-box"><span class="kpi-title">×ª×©×•××” ×œ×”×•×Ÿ (ROE)</span><span class="kpi-val" id="mROE">-</span></div>
            </div>

            <div class="charts-wrapper">
                <div class="chart-box">
                    <div class="chart-title"><span>××’××ª ×”×›× ×¡×•×ª ×•×¨×•×•×— (×¨×‘×¢×•× ×™)</span> <span style="font-size:11px;">×©× ×ª×™×™× ××—×¨×•× ×•×ª</span></div>
                    <canvas id="revChart"></canvas>
                </div>
                <div class="chart-box">
                    <div class="chart-title"><span>×©×•×œ×™ ×¨×•×•×— (%)</span></div>
                    <canvas id="marginChart"></canvas>
                </div>
            </div>

            <div id="mGuidanceText" style="line-height:1.6; font-size:14px;"></div>

            <div class="chart-title" style="margin-top:10px;">×˜×‘×œ×ª × ×ª×•× ×™×</div>
            <div class="table-wrap">
                <table class="hist-table" id="mHistoryTable">
                    <thead><tr><th>×ª××¨×™×š</th><th>×”×›× ×¡×•×ª ($)</th><th>×¨×•×•×— × ×§×™ ($)</th><th>×©×•×œ×™ ×¨×•×•×—</th><th>×ª×–×¨×™× ×—×•×¤×©×™ (FCF)</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <div style="font-size:11px; color:var(--text-muted); text-align:center;">
                * × ×ª×•× ×™× ×›×¡×¤×™×™× ×‘××™×œ×™×•× ×™×/××™×œ×™××¨×“×™×. FCF = ×ª×–×¨×™× ×ª×¤×¢×•×œ×™ ×¤×—×•×ª ×”×©×§×¢×•×ª (Capex).
            </div>
        </div>
    </div>
</div>

<script>
    // --- SAFE DOM HELPERS ---
    function setText(id, val) { const el=document.getElementById(id); if(el) el.innerText = (val!==undefined&&val!==null)?val:"-"; }
    function setHtml(id, val) { const el=document.getElementById(id); if(el) el.innerHTML = val||""; }
    function setClass(id, cls) { const el=document.getElementById(id); if(el) el.className = cls; }

    // --- GLOBALS ---
    let allData = [], historyData = {};
    let currentView = 'list';
    let navigationDate = new Date();
    let activeFilters = { sectors: [], indices: [], lists: [] };
    let sliderInstance = null, minCap = 1e9, maxCap = 5e12;
    let revChartInstance = null, marginChartInstance = null;

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', async () => {
        const loader = document.getElementById('main-container');
        const buster = new Date().getTime();
        
        try {
            // 1. Fetch Main Data
            const res = await fetch(`./data.json?v=${buster}`);
            if(!res.ok) throw new Error("Missing data.json");
            const data = await res.json();
            allData = data.filter(d => d.earningsDate !== '?' && d.earningsDate !== 'TBD');
            
            // 2. Fetch History (Optional)
            fetch(`./history_data.json?v=${buster}`).then(r=>r.json()).then(h=>{ historyData=h; }).catch(e=>console.log("No history"));

            // 3. UI Init
            const secDiv = document.getElementById('sectorOptions');
            if(secDiv) {
                secDiv.innerHTML = '';
                [...new Set(allData.map(d => d.sector))].sort().forEach(s => {
                    secDiv.innerHTML += `<div class="ms-option" onclick="toggleFilter('sectors','${s}')"><input type="checkbox" value="${s}"><span>${s}</span></div>`;
                });
            }
            
            initSlider();
            updateDateDisplay();
            applyFilters();

        } catch (err) {
            loader.innerHTML = `<div style="color:#ef4444;">×©×’×™××”: ${err.message}<br>×”×¨×¥ ××ª get_data.py</div>`;
        }
    });

    // --- CHART.JS LOGIC ---
    function renderCharts(symbol, history) {
        if (!history || history.length === 0) return;

        // Prepare Data (Reverse to show oldest -> newest)
        const labels = history.map(h => h.date).reverse();
        const revData = history.map(h => h.revenue).reverse();
        const netData = history.map(h => h.netIncome).reverse();
        const marginData = history.map(h => h.margin).reverse();

        // 1. Revenue & Net Income Chart
        const ctxRev = document.getElementById('revChart').getContext('2d');
        if (revChartInstance) revChartInstance.destroy(); // Clear old chart

        revChartInstance = new Chart(ctxRev, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: '×”×›× ×¡×•×ª', data: revData, backgroundColor: '#3b82f6', borderRadius: 4 },
                    { label: '×¨×•×•×— × ×§×™', data: netData, backgroundColor: '#10b981', borderRadius: 4 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } },
                scales: {
                    x: { ticks: { color: '#94a3b8' }, grid: { display: false } },
                    y: { ticks: { color: '#94a3b8', callback: (val) => '$' + formatCompact(val) }, grid: { color: '#334155' } }
                }
            }
        });

        // 2. Margin Chart
        const ctxMar = document.getElementById('marginChart').getContext('2d');
        if (marginChartInstance) marginChartInstance.destroy();

        marginChartInstance = new Chart(ctxMar, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{ 
                    label: '×©×•×œ×™ ×¨×•×•×— (%)', data: marginData, 
                    borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)', 
                    tension: 0.4, fill: true, pointRadius: 3 
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } }
                }
            }
        });
    }

    // --- MODAL POPULATION ---
    function openFinancialModal(stock) {
        setText('mSymbol', stock.symbol);
        setText('mName', stock.name);
        
        // Colors for sector badge
        const secEl = document.getElementById('mSector');
        if(secEl) {
            secEl.innerText = stock.sector;
            let cls = 'bg-other';
            if(stock.sector.includes('Tech')) cls = 'bg-tech';
            if(stock.sector.includes('Fin')) cls = 'bg-fin';
            if(stock.sector.includes('Health')) cls = 'bg-health';
            secEl.className = `badge ${cls}`;
        }

        // KPIs
        setText('mCap', formatMoney(stock.marketCap));
        setText('mPE', stock.trailingPE ? stock.trailingPE.toFixed(1) : "-");
        setText('mRev', formatMoney(stock.revenue));
        
        const divY = stock.dividendYield;
        setText('mDiv', divY ? (divY * 100).toFixed(2) + "%" : "-");
        
        const roe = stock.returnOnEquity;
        setText('mROE', roe ? (roe * 100).toFixed(1) + "%" : "-");
        const roeEl = document.getElementById('mROE');
        if(roeEl) roeEl.style.color = roe > 0.15 ? '#10b981' : '#e0e0e0';

        // History Data Processing
        const histData = historyData[stock.symbol];
        let analysisHtml = "";
        
        if (histData) {
            // Render Charts
            renderCharts(stock.symbol, histData.quarterlyHistory);
            
            // Growth Badge
            if(histData.yoyRevenueGrowth) {
                const g = histData.yoyRevenueGrowth;
                const col = g > 0 ? 'bg-pass' : 'bg-warn';
                const txt = g > 0 ? '×¦××™×—×”' : '×™×¨×™×“×”';
                analysisHtml += `<div style="margin-bottom:10px;"><span class="badge ${col}">${txt} ×©× ×ª×™×ª</span> ×”×›× ×¡×•×ª ×”×©×ª× ×• ×‘-${g}% ×œ×¢×•××ª ×©× ×” ×©×¢×‘×¨×”.</div>`;
            }
            
            // Populate Table
            const tbody = document.querySelector('#mHistoryTable tbody');
            if(tbody) {
                tbody.innerHTML = '';
                if (histData.quarterlyHistory && histData.quarterlyHistory.length > 0) {
                    histData.quarterlyHistory.forEach(q => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${q.date}</td>
                            <td>${formatCompact(q.revenue)}</td>
                            <td class="${q.netIncome > 0 ? 'val-green' : 'val-red'}">${formatCompact(q.netIncome)}</td>
                            <td>${q.margin}%</td>
                            <td class="${q.freeCashFlow > 0 ? 'val-green' : 'val-red'}">${formatCompact(q.freeCashFlow)}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            }
        } else {
            // ×× ××™×Ÿ ×”×™×¡×˜×•×¨×™×” - ×”×¡×ª×¨×ª ×’×¨×¤×™× ×•×”×¦×’×ª ×”×•×“×¢×”
            const tbody = document.querySelector('#mHistoryTable tbody');
            if(tbody) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">××™×Ÿ × ×ª×•× ×™× ×”×™×¡×˜×•×¨×™×™×</td></tr>';
            // (××¤×©×¨ ×’× ×œ×”×¡×ª×™×¨ ××ª ×”×§× ×‘×¡ ×›××Ÿ)
        }
        
        // Guidance / Links
        const yahooUrl = `https://finance.yahoo.com/quote/${stock.symbol}`;
        const tvUrl = `https://www.tradingview.com/chart/?symbol=${stock.symbol}`;
        analysisHtml += `<div style="margin-top:15px;">
            <a href="${yahooUrl}" target="_blank" style="color:var(--accent-blue); text-decoration:none; margin-left:10px;">ğŸ”— Yahoo Finance</a>
            <a href="${tvUrl}" target="_blank" style="color:var(--accent-blue); text-decoration:none;">ğŸ“ˆ TradingView</a>
        </div>`;
        setHtml('mGuidanceText', analysisHtml);

        document.getElementById('finModal').classList.add('open');
    }

    function closeModal() { document.getElementById('finModal').classList.remove('open'); }

    // --- FILTERS & LIST VIEW ---
    function applyFilters() {
        const q = document.getElementById('searchInput').value.toLowerCase().trim();
        let filtered = allData.filter(item => {
            const mCap = item.marketCap >= minCap && item.marketCap <= maxCap;
            const mSec = activeFilters.sectors.length === 0 || activeFilters.sectors.includes(item.sector);
            let mIdx = true;
            if (activeFilters.indices.length > 0) {
                mIdx = false;
                if (activeFilters.indices.includes('sp500') && item.inSp500) mIdx = true;
                if (activeFilters.indices.includes('nasdaq100') && item.inNasdaq100) mIdx = true;
                // ETFs Check
                if (activeFilters.indices.includes('vti') && item.symbol === 'VTI') mIdx = true;
                if (activeFilters.indices.includes('schd') && item.symbol === 'SCHD') mIdx = true;
                if (activeFilters.indices.includes('vug') && item.symbol === 'VUG') mIdx = true;
            }
            return mSec && mCap && mIdx;
        });

        if (q) filtered = filtered.filter(i => i.symbol.toLowerCase().includes(q) || i.name.toLowerCase().includes(q));
        else filtered.sort((a, b) => new Date(a.earningsDate) - new Date(b.earningsDate));
        
        // Date Filtering based on View
        let displayData = [];
        if (currentView === 'month') {
            const y = navigationDate.getFullYear(), m = navigationDate.getMonth();
            displayData = filtered.filter(d => { const dt = new Date(d.earningsDate); return dt.getFullYear()===y && dt.getMonth()===m; });
        } else {
            const d = new Date(navigationDate); const day = d.getDay(); d.setDate(d.getDate() - day);
            const start = new Date(d); const end = new Date(d); end.setDate(end.getDate() + 7);
            displayData = filtered.filter(i => { const dt = new Date(i.earningsDate); return dt >= start && dt < end; });
        }
        
        setText('stats-counter', `× ××¦××• ${displayData.length}`);
        const container = document.getElementById('main-container');
        container.innerHTML = '';
        
        if(currentView === 'list') {
            // Group by Date
            const grouped = {}; displayData.forEach(s => { if(!grouped[s.earningsDate]) grouped[s.earningsDate]=[]; grouped[s.earningsDate].push(s); });
            Object.keys(grouped).sort().forEach(date => {
                const sect = document.createElement('div');
                const dObj = new Date(date);
                sect.innerHTML = `<div style="font-weight:500; color:var(--accent-blue); margin:20px 0 10px 0; border-bottom:1px solid var(--border-color);">${date} - ${dObj.toLocaleDateString('he-IL',{weekday:'long'})}</div>`;
                const grid = document.createElement('div'); grid.className = 'cards-grid';
                grouped[date].forEach(s => grid.appendChild(createCard(s)));
                sect.appendChild(grid); container.appendChild(sect);
            });
        } else {
            // Calendar View logic (Simplified for this full-merge)
            container.innerHTML = `<div style="text-align:center; padding:20px;">×ª×¦×•×’×ª ×œ×•×— ×©× ×” (×—×•×“×©×™) - ×™×© ×œ×’×œ×•×œ ×‘×¨×©×™××”</div>`;
            const grid = document.createElement('div'); grid.className = 'cards-grid';
            displayData.forEach(s => grid.appendChild(createCard(s)));
            container.appendChild(grid);
        }
    }

    function createCard(stock) {
        const el = document.createElement('div');
        el.className = 'stock-card';
        let strip = '#64748b';
        if(stock.sector.includes('Tech')) strip='#3b82f6';
        if(stock.sector.includes('Fin')) strip='#10b981';
        
        el.innerHTML = `
            <div class="card-strip" style="background:${strip}"></div>
            <div class="card-top">
                <img src="https://assets.parqet.com/logos/symbol/${stock.symbol}?format=png" class="stock-logo" onerror="this.style.opacity=0">
                <div><span class="symbol">${stock.symbol}</span><span class="market-cap">$${formatCompact(stock.marketCap)}</span></div>
            </div>
            <div class="company-name">${stock.name}</div>
            <div class="card-footer">
                <span class="tag-text" style="background:rgba(255,255,255,0.05)">${stock.sector}</span>
                ${stock.time ? `<span class="badge" style="background:rgba(255,255,255,0.1)">${stock.time.includes('After')?'ğŸŒ™':'â˜€ï¸'}</span>` : ''}
            </div>
        `;
        el.onclick = () => openFinancialModal(stock);
        return el;
    }

    // --- HELPERS & CONTROLS ---
    function formatMoney(n) { 
        if (!n) return "-";
        if (n >= 1e12) return "$" + (n / 1e12).toFixed(2) + "T";
        if (n >= 1e9) return "$" + (n / 1e9).toFixed(2) + "B";
        if (n >= 1e6) return "$" + (n / 1e6).toFixed(2) + "M";
        return n.toLocaleString();
    }
    function formatCompact(n) { // Short version for charts
        if (!n) return "0";
        if (Math.abs(n) >= 1e9) return (n / 1e9).toFixed(1) + "B";
        if (Math.abs(n) >= 1e6) return (n / 1e6).toFixed(1) + "M";
        return n.toLocaleString();
    }

    function initSlider() {
        const s = document.getElementById('marketCapSlider');
        if(s.noUiSlider) return;
        noUiSlider.create(s, { start: [minCap, maxCap], connect: true, range: { 'min': 1e9, '30%': 50e9, '70%': 200e9, 'max': 5e12 } });
        sliderInstance = s.noUiSlider;
        s.noUiSlider.on('update', (v) => { minCap=parseFloat(v[0]); maxCap=parseFloat(v[1]); document.getElementById('sliderValues').innerText = `${formatCompact(minCap)} - ${formatCompact(maxCap)}`; applyFilters(); });
    }
    function setSliderRange(a, b) { if(sliderInstance) sliderInstance.set([a, b]); }
    
    function changeDate(d) { 
        if(currentView==='month') navigationDate.setMonth(navigationDate.getMonth()+d); 
        else navigationDate.setDate(navigationDate.getDate()+(d*7)); 
        updateDateDisplay(); applyFilters(); 
    }
    function updateDateDisplay() {
        const opts = { month: 'long', year: 'numeric' };
        let txt = navigationDate.toLocaleDateString('he-IL', opts);
        if(currentView!=='month') {
            const d = new Date(navigationDate); const day = d.getDay(); d.setDate(d.getDate()-day);
            const e = new Date(d); e.setDate(e.getDate()+6);
            txt = `${d.getDate()}/${d.getMonth()+1} - ${e.getDate()}/${e.getMonth()+1}`;
        }
        setText('dateDisplay', txt);
    }
    function switchView(v) { currentView = v; document.querySelectorAll('.view-btn').forEach(b=>b.classList.remove('active')); document.getElementById(`btn-${v}`).classList.add('active'); updateDateDisplay(); applyFilters(); }
    
    // Toggle Dropdowns
    function toggleDropdown(id) { document.querySelector(`#${id} .ms-content`).classList.toggle('show'); }
    function toggleFilter(type, val) { 
        const arr = activeFilters[type]; 
        const idx = arr.indexOf(val); 
        if(idx>-1) arr.splice(idx,1); else arr.push(val); 
        applyFilters(); 
        // Update Button Style
        const btn = document.querySelector(`#${type==='indices'?'indexMS':'sectorMS'} .ms-btn`);
        if(arr.length>0) btn.style.borderColor = 'var(--accent-blue)'; else btn.style.borderColor = 'var(--border-color)';
    }
    
    // Theme
    function toggleTheme() { 
        const r = document.documentElement; 
        const isDark = r.getAttribute('data-theme')==='dark';
        r.setAttribute('data-theme', isDark?'light':'dark'); 
        // Re-render charts to fix colors if modal is open
        const modal = document.getElementById('finModal');
        if(modal.classList.contains('open')) closeModal(); 
    }
    
    window.onclick = (e) => { if(!e.target.closest('.multi-select')) document.querySelectorAll('.ms-content').forEach(el=>el.classList.remove('show')); }
    document.getElementById('searchInput').addEventListener('keyup', applyFilters);
</script>
</body>
</html>
