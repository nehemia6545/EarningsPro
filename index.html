<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>

<script>
    // --- ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ---
    let allData = [];
    let historyData = {}; 
    let userLists = {};
    let activeFilters = { sectors: [], indices: [], lists: [] };
    let sliderInstance = null;
    let currentMinCap = 1000000000;
    let currentMaxCap = 5000000000000;

    // --- ×˜×¢×™× ×ª ×¨×©×™××•×ª ××©×ª××© ---
    try {
        const stored = localStorage.getItem('userLists');
        userLists = stored ? JSON.parse(stored) : { "××•×¢×“×¤×™×": [] };
    } catch (e) { 
        userLists = { "××•×¢×“×¤×™×": [] }; 
    }

    // --- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ---
    function formatMoney(n) { 
        if (n === undefined || n === null || n === 0) return "-"; 
        if (n >= 1e12) return "$" + (n / 1e12).toFixed(2) + "T"; 
        if (n >= 1e9) return "$" + (n / 1e9).toFixed(1) + "B"; 
        if (n >= 1e6) return "$" + (n / 1e6).toFixed(1) + "M"; 
        return n.toLocaleString(); 
    }
    function formatPct(n) { 
        if (n === undefined || n === null) return "-"; 
        return (n * 100).toFixed(1) + "%"; 
    }
    function getColorClass(n) { return n > 0 ? 'val-green' : (n < 0 ? 'val-red' : ''); }

    // --- ×˜×¢×™× ×ª × ×ª×•× ×™× (×”×—×œ×§ ×”××ª×•×§×Ÿ) ---
    async function loadData() {
        const loader = document.getElementById('main-container');
        loader.innerHTML = '<div style="text-align:center;padding:50px;color:#888;">×˜×•×¢×Ÿ × ×ª×•× ×™× ×¢×“×›× ×™×™×...</div>';
        
        // Cache Buster: ××•×¡×™×£ ××¡×¤×¨ ×¨× ×“×•××œ×™ ×œ×›×ª×•×‘×ª ×›×“×™ ×œ×¢×§×•×£ ×–×™×›×¨×•×Ÿ ××˜××•×Ÿ
        const cacheBuster = new Date().getTime();

        try {
            // 1. ×˜×¢×™× ×ª ×”× ×ª×•× ×™× ×”×¨××©×™×™× (×—×•×‘×”)
            const response = await fetch(`./data.json?v=${cacheBuster}`);
            if (!response.ok) throw new Error('Data file not found');
            const data = await response.json();
            
            allData = data.filter(d => d.earningsDate !== '?' && d.earningsDate !== 'TBD');
            
            // ××ª×—×•×œ ×¨××©×•× ×™ ×©×œ ×”××ª×¨
            const secDiv = document.getElementById('sectorOptions'); 
            secDiv.innerHTML = '';
            [...new Set(allData.map(d => d.sector))].sort().forEach(s => {
                secDiv.innerHTML += `<div class="ms-option" onclick="toggleFilter('sectors','${s}')"><input type="checkbox" value="${s}"><span>${s}</span></div>`;
            });
            
            initListFilter();
            initExternalSlider();
            updateDateDisplay(); 
            applyFilters(); // ×”×¦×’×ª ×”× ×ª×•× ×™×

            // 2. ×˜×¢×™× ×ª ×”×™×¡×˜×•×¨×™×” (××•×¤×¦×™×•× ×œ×™ - ×œ× ×ª×•×§×¢ ××ª ×”××ª×¨ ×× × ×›×©×œ)
            try {
                const histRes = await fetch(`./history_data.json?v=${cacheBuster}`);
                if (histRes.ok) {
                    historyData = await histRes.json();
                    console.log("History data loaded successfully");
                }
            } catch (err) {
                console.warn("History data not found, skipping.");
            }

        } catch (error) {
            console.error(error);
            loader.innerHTML = `<div style="text-align:center;padding:50px;color:red;">
                <h3>×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×</h3>
                <p>×•×“× ×©×”×§×•×‘×¥ data.json ×§×™×™× ×‘×ª×™×§×™×™×” ×•×©×”×•×¢×œ×” ×œ-GitHub.</p>
                <p>×©×’×™××” ×˜×›× ×™×ª: ${error.message}</p>
            </div>`;
        }
    }

    // ×”×¤×¢×œ×ª ×”×˜×¢×™× ×”
    loadData();


    // --- FINANCIAL MODAL LOGIC (×—×œ×•×Ÿ ×”×¤×¨×˜×™×) ---
    function openFinancialModal(stock) {
        // ××™×œ×•×™ ×›×•×ª×¨×•×ª
        document.getElementById('mSymbol').innerText = stock.symbol || "-";
        document.getElementById('mName').innerText = stock.name || "-";
        document.getElementById('mSector').innerText = stock.sector || "-";

        // KPI
        document.getElementById('mCap').innerText = formatMoney(stock.marketCap);
        document.getElementById('mPE').innerText = stock.trailingPE ? stock.trailingPE.toFixed(1) : "-";
        document.getElementById('mEPS').innerText = stock.eps ? "$" + stock.eps.toFixed(2) : "-";
        
        const roe = stock.returnOnEquity;
        const roeEl = document.getElementById('mROE');
        roeEl.innerText = formatPct(roe);
        roeEl.className = "kpi-value " + (roe > 0.15 ? 'val-green' : '');

        // ×“×•×— ×¨×•×•×— ×•×”×¤×¡×“
        document.getElementById('mRev').innerText = formatMoney(stock.revenue);
        const revG = document.getElementById('mRevGrowth');
        revG.innerText = formatPct(stock.revenueGrowth);
        revG.className = getColorClass(stock.revenueGrowth);
        document.getElementById('mNetInc').innerText = formatMoney(stock.netIncome);
        document.getElementById('mGrossMarg').innerText = formatPct(stock.grossMargins);

        // ×××–×Ÿ
        document.getElementById('mCash').innerText = formatMoney(stock.totalCash);
        document.getElementById('mDebt').innerText = formatMoney(stock.totalDebt);
        const cr = stock.currentRatio;
        const crEl = document.getElementById('mCurrRatio');
        crEl.innerText = cr ? cr.toFixed(2) : "-";
        crEl.className = cr >= 1.5 ? 'val-green' : (cr < 1 ? 'val-red' : '');

        // ×ª×–×¨×™×
        document.getElementById('mOCF').innerText = formatMoney(stock.operatingCashflow);
        const fcf = stock.freeCashflow;
        const fcfEl = document.getElementById('mFCF');
        fcfEl.innerText = formatMoney(fcf);
        fcfEl.className = fcf > 0 ? 'val-green' : '';
        document.getElementById('mDiv').innerText = formatPct(stock.dividendYield);

        // --- GUIDANCE & ANALYSIS ---
        let analysisHtml = "";
        
        // 1. × ×ª×•× ×™× ×”×™×¡×˜×•×¨×™×™× (×× ×™×©)
        const hist = historyData[stock.symbol];
        
        if (hist) {
            // ×× ×™×© ××™×“×¢ ×¢×œ ×¦××™×—×” ×”×™×¡×˜×•×¨×™×ª ××”×§×•×‘×¥ ×”×—×“×©
            if(hist.yoyRevenueGrowth) {
                const growthColor = hist.yoyRevenueGrowth > 0 ? 'bg-pass' : 'bg-warn';
                analysisHtml += `<div style="margin-bottom:8px;"><span class="badge ${growthColor}">×¦××™×—×” ×©× ×ª×™×ª</span> ×”×›× ×¡×•×ª ×¦××—×• ×‘-${hist.yoyRevenueGrowth}% ×œ×¢×•××ª ×©× ×” ×©×¢×‘×¨×”.</div>`;
            }
        }

        // 2. × ×ª×•× ×™× ×©×•×˜×¤×™×
        if (stock.forwardPE && stock.trailingPE) {
            if (stock.forwardPE < stock.trailingPE) {
                analysisHtml += `<div><span class="badge bg-pass">×—×™×•×‘×™</span> ×¦×¤×™ ×œ×’×™×“×•×œ ×‘×¨×•×•×—×™× (Forward P/E × ××•×š ××”× ×•×›×—×™).</div>`;
            } else {
                analysisHtml += `<div><span class="badge bg-warn">×–×”×™×¨×•×ª</span> ×¦×¤×™ ×œ×”××˜×” ×‘×¨×•×•×—×™× ××• ×™×¨×™×“×”.</div>`;
            }
        }
        
        // ×§×™×©×•×¨×™× ×—×™×¦×•× ×™×™×
        const tvUrl = `https://www.tradingview.com/chart/?symbol=${stock.symbol}`;
        const yahooUrl = `https://finance.yahoo.com/quote/${stock.symbol}`;
        
        analysisHtml += `<div style="margin-top:15px; font-size:12px; color:#888;">
            <a href="${yahooUrl}" target="_blank" style="color:var(--accent-blue); text-decoration:none;">ğŸ”— Yahoo Finance</a> | 
            <a href="${tvUrl}" target="_blank" style="color:var(--accent-blue); text-decoration:none;">ğŸ“ˆ TradingView</a>
        </div>`;

        document.getElementById('mGuidanceText').innerHTML = analysisHtml;

        // --- HISTORY TABLE POPULATION ---
        const tbody = document.querySelector('#mHistoryTable tbody');
        tbody.innerHTML = ''; // × ×™×§×•×™
        
        if (hist && hist.quarterlyHistory && hist.quarterlyHistory.length > 0) {
            // ××™×œ×•×™ ×”×˜×‘×œ×” ××ª×•×š ×§×•×‘×¥ ×”×”×™×¡×˜×•×¨×™×”
            hist.quarterlyHistory.forEach(q => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${q.date}</td>
                    <td>${formatMoney(q.revenue)}</td>
                    <td class="${q.netIncome > 0 ? 'val-green' : 'val-red'}">${formatMoney(q.netIncome)}</td>
                    <td>${q.grossMargin}%</td>
                    <td class="${q.freeCashFlow > 0 ? 'val-green' : 'val-red'}">${formatMoney(q.freeCashFlow)}</td>
                `;
                tbody.appendChild(tr);
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:15px; color:#666;">××™×Ÿ × ×ª×•× ×™× ×”×™×¡×˜×•×¨×™×™× ×–××™× ×™× (×”×¨×¥ ××ª get_history.py)</td></tr>';
        }

        document.getElementById('finModal').classList.add('open');
    }

    // --- ×©××¨ ×”×¤×•× ×§×¦×™×•×ª (×¤×™×œ×˜×¨×™×, ×¡×œ×™×™×“×¨×™×) ---
    
    function initExternalSlider() {
        const slider = document.getElementById('marketCapSlider');
        if(slider.noUiSlider) slider.noUiSlider.destroy(); // ×× ×™×¢×ª ×›×¤×™×œ×•×ª
        
        noUiSlider.create(slider, {
            start: [1000000000, 5000000000000], connect: true,
            range: { 'min': [1000000000, 1000000000], '30%': [50000000000, 5000000000], '70%': [500000000000, 50000000000], 'max': [5000000000000] }
        });
        sliderInstance = slider.noUiSlider;
        slider.noUiSlider.on('update', function (values) {
            currentMinCap = parseFloat(values[0]); currentMaxCap = parseFloat(values[1]);
            document.getElementById('sliderValues').innerText = `${formatMoney(currentMinCap)} - ${formatMoney(currentMaxCap)}`;
            applyFilters();
        });
    }
    function setSliderRange(min, max) { if(sliderInstance) sliderInstance.set([min, max]); }

    function toggleDropdown(id) { document.querySelectorAll('.ms-content').forEach(el => { if(el.parentElement.id !== id) el.classList.remove('show'); }); document.querySelector(`#${id} .ms-content`).classList.toggle('show'); }
    window.onclick = function(e) { if (!e.target.closest('.multi-select')) document.querySelectorAll('.ms-content').forEach(el => el.classList.remove('show')); }
    
    function toggleFilter(cat, val) { const idx = activeFilters[cat].indexOf(val); if (idx > -1) activeFilters[cat].splice(idx, 1); else activeFilters[cat].push(val); updateFilterUI(); applyFilters(); }
    function updateFilterUI() {
        updateBtnText('sectorMS', '×¡×§×˜×•×¨×™×', activeFilters.sectors);
        updateBtnText('listsMS', '×¨×©×™××•×ª', activeFilters.lists);
        updateBtnText('indexMS', '××“×“×™×', activeFilters.indices);
        document.querySelectorAll('.ms-option input').forEach(inp => {
            const cat = inp.closest('.multi-select').id === 'sectorMS' ? 'sectors' : (inp.closest('.multi-select').id === 'indexMS' ? 'indices' : 'lists');
            inp.checked = activeFilters[cat].includes(inp.value);
        });
    }
    function updateBtnText(id, txt, arr) { const btn = document.querySelector(`#${id} .ms-btn`); btn.innerHTML = arr.length > 0 ? `<span class="ms-badge">${arr.length}</span> ${txt}` : txt; arr.length > 0 ? btn.classList.add('active') : btn.classList.remove('active'); }

    function saveUserLists() { localStorage.setItem('userLists', JSON.stringify(userLists)); initListFilter(); applyFilters(); }
    function initListFilter() { const div = document.getElementById('listsOptions'); div.innerHTML = ''; Object.keys(userLists).forEach(l => div.innerHTML += `<div class="ms-option" onclick="toggleFilter('lists','${l}')"><input type="checkbox" value="${l}"><span>${l}</span></div>`); }
    function openListModal(event, symbol) {
        event.stopPropagation(); currentModalSymbol = symbol;
        document.getElementById('modalSymbol').innerText = symbol;
        const container = document.getElementById('modalListsContainer'); container.innerHTML = '';
        Object.keys(userLists).forEach(listName => {
            const isChecked = userLists[listName].includes(symbol);
            const div = document.createElement('div'); div.className = 'list-option';
            div.innerHTML = `<div style="display:flex;align-items:center;gap:10px;flex:1" onclick="toggleStockInList('${listName}', '${symbol}')"><input type="checkbox" ${isChecked ? 'checked' : ''} readonly><span>${listName}</span></div><span onclick="deleteList(event, '${listName}')" style="cursor:pointer;color:#d32f2f;">ğŸ—‘ï¸</span>`;
            container.appendChild(div);
        });
        document.getElementById('listsModal').classList.add('open');
    }
    function toggleStockInList(listName, symbol) { if (!userLists[listName]) return; userLists[listName] = userLists[listName].includes(symbol) ? userLists[listName].filter(s => s !== symbol) : [...userLists[listName], symbol]; saveUserLists(); openListModal({stopPropagation:()=>{}}, currentModalSymbol); }
    function deleteList(e, listName) { e.stopPropagation(); if(confirm('×œ××—×•×§?')) { delete userLists[listName]; const i = activeFilters.lists.indexOf(listName); if(i>-1) activeFilters.lists.splice(i,1); updateFilterUI(); saveUserLists(); openListModal({stopPropagation:()=>{}}, currentModalSymbol); } }
    function createNewList() { const name = document.getElementById('newListName').value.trim(); if(name && !userLists[name]) { userLists[name] = currentModalSymbol ? [currentModalSymbol] : []; saveUserLists(); document.getElementById('newListName').value=''; openListModal({stopPropagation:()=>{}}, currentModalSymbol); } }
    function closeModal(e) { if(e.target.id === 'listsModal' || e.target.id === 'finModal' || e.target.id === 'dayDetailsModal') closeModalForce(e.target.id); }
    function closeModalForce(id) { document.getElementById(id).classList.remove('open'); }
    
    function openDayModal(dateStr, stocks) {
        const d = new Date(dateStr);
        document.getElementById('dayModalTitle').innerText = `×“×™×•×•×—×™×: ${dateStr}`;
        const grid = document.getElementById('dayModalGrid'); grid.innerHTML = '';
        stocks.forEach(s => { grid.appendChild(createCard(s, 'full')); });
        document.getElementById('dayDetailsModal').classList.add('open');
    }
    
    function isStockStarred(symbol) { for (const list in userLists) { if (userLists[list].includes(symbol)) return true; } return false; }
    function toggleTheme() { document.documentElement.setAttribute('data-theme', document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }
    function getSectorMeta(sector) {
        if (!sector) return ['sec-other', 'bg-other']; const s = sector.toLowerCase();
        if (s.includes('tech')) return ['sec-tech', 'bg-tech']; if (s.includes('fin')) return ['sec-fin', 'bg-fin'];
        if (s.includes('health')) return ['sec-health', 'bg-health']; if (s.includes('cons')) return ['sec-cons', 'bg-cons'];
        return ['sec-other', 'bg-other'];
    }

    function changeDate(delta) {
        if (currentView === 'month') navigationDate.setMonth(navigationDate.getMonth() + delta);
        else navigationDate.setDate(navigationDate.getDate() + (delta * 7));
        updateDateDisplay(); applyFilters();
    }
    function updateDateDisplay() {
        const opts = { month: 'numeric', day: 'numeric' };
        if (currentView === 'month') document.getElementById('dateDisplay').innerText = navigationDate.toLocaleDateString('he-IL', { year: 'numeric', month: 'long' });
        else {
            const d = new Date(navigationDate); const day = d.getDay(); d.setDate(d.getDate() - day);
            const start = new Date(d); const end = new Date(d); end.setDate(end.getDate() + 6);
            document.getElementById('dateDisplay').innerText = `${start.toLocaleDateString('he-IL', opts)} - ${end.toLocaleDateString('he-IL', opts)}`;
        }
    }
    
    // --- MAIN RENDER LOGIC ---
    function applyFilters() {
        const q = document.getElementById('searchInput').value.toLowerCase().trim();
        const minCap = currentMinCap; const maxCap = currentMaxCap;
        
        let filtered = allData.filter(item => {
            const mCap = item.marketCap >= minCap && item.marketCap <= maxCap;
            const mSec = activeFilters.sectors.length === 0 || activeFilters.sectors.includes(item.sector);
            let mIdx = true;
            if (activeFilters.indices.length > 0) {
                mIdx = false;
                if (activeFilters.indices.includes('sp500') && item.inSp500) mIdx = true;
                if (activeFilters.indices.includes('nasdaq100') && item.inNasdaq100) mIdx = true;
                if (activeFilters.indices.includes('dia') && item.inDow) mIdx = true;
                // ETFs Check
                if (activeFilters.indices.includes('vti') && item.symbol === 'VTI') mIdx = true;
                if (activeFilters.indices.includes('vt') && item.symbol === 'VT') mIdx = true;
                if (activeFilters.indices.includes('vxus') && item.symbol === 'VXUS') mIdx = true;
                if (activeFilters.indices.includes('schd') && item.symbol === 'SCHD') mIdx = true;
                if (activeFilters.indices.includes('vig') && item.symbol === 'VIG') mIdx = true;
                if (activeFilters.indices.includes('vug') && item.symbol === 'VUG') mIdx = true;
                if (activeFilters.indices.includes('vtv') && item.symbol === 'VTV') mIdx = true;
                if (activeFilters.indices.includes('ijh') && item.symbol === 'IJH') mIdx = true;
                if (activeFilters.indices.includes('avuv') && item.symbol === 'AVUV') mIdx = true;
            }
            let mLst = true;
            if (activeFilters.lists.length > 0) {
                mLst = false; for (let listName of activeFilters.lists) { if (userLists[listName] && userLists[listName].includes(item.symbol)) { mLst = true; break; } }
            }
            return mSec && mCap && mIdx && mLst;
        });

        if (q) filtered = filtered.filter(i => i.symbol.toLowerCase().includes(q) || i.name.toLowerCase().includes(q));
        else filtered.sort((a, b) => new Date(a.earningsDate) - new Date(b.earningsDate));
        
        let displayData = [];
        if (currentView === 'month') {
            const y = navigationDate.getFullYear(); const m = navigationDate.getMonth();
            displayData = filtered.filter(d => { const dt = new Date(d.earningsDate); return dt.getFullYear() === y && dt.getMonth() === m; });
        } else {
            const d = new Date(navigationDate); const day = d.getDay(); d.setDate(d.getDate() - day); d.setHours(0,0,0,0);
            const end = new Date(d); end.setDate(end.getDate() + 7);
            displayData = filtered.filter(i => { const dt = new Date(i.earningsDate); return dt >= d && dt < end; });
        }
        document.getElementById('stats-counter').innerText = `× ××¦××• ${displayData.length}`;
        if (currentView === 'list') renderListView(displayData); else renderCalendarGrid(displayData, currentView);
    }

    function renderListView(data) {
        const container = document.getElementById('main-container'); container.innerHTML = '';
        if (data.length === 0) { container.innerHTML = '<div style="text-align:center;color:#888;">××™×Ÿ ×ª×•×¦××•×ª</div>'; return; }
        const grouped = {}; data.forEach(s => { if(!grouped[s.earningsDate]) grouped[s.earningsDate]=[]; grouped[s.earningsDate].push(s); });
        Object.keys(grouped).sort().forEach(date => {
            const section = document.createElement('div'); section.className = 'date-section';
            const d = new Date(date); section.innerHTML = `<div class="date-header">${date} - ${d.toLocaleDateString('he-IL', {weekday:'long'})}</div>`;
            const grid = document.createElement('div'); grid.className = 'cards-grid';
            grouped[date].sort((a,b)=>b.marketCap-a.marketCap).forEach(s => grid.appendChild(createCard(s, 'full')));
            section.appendChild(grid); container.appendChild(section);
        });
    }

    function renderCalendarGrid(data, type) {
        const container = document.getElementById('main-container'); container.innerHTML = '';
        const grid = document.createElement('div'); grid.className = `calendar-grid ${type==='week'?'week-view':''}`;
        const isMobile = window.innerWidth <= 768;
        if (!isMobile || type === 'month') { ['×','×‘','×’','×“','×”','×•','×©'].forEach(d => { const h = document.createElement('div'); h.className = 'calendar-day-header'; h.innerText = d; grid.appendChild(h); }); }
        let startD, daysCount;
        if (type === 'month') {
            startD = new Date(navigationDate.getFullYear(), navigationDate.getMonth(), 1);
            daysCount = new Date(navigationDate.getFullYear(), navigationDate.getMonth()+1, 0).getDate();
            if(!isMobile) for(let i=0; i<startD.getDay(); i++) grid.appendChild(document.createElement('div'));
        } else {
            const d = new Date(navigationDate); const day = d.getDay(); d.setDate(d.getDate() - day);
            startD = new Date(d); daysCount = 7;
        }
        for (let i=0; i<daysCount; i++) {
            const current = new Date(startD); 
            if (type === 'month') current.setDate(i+1); else current.setDate(startD.getDate() + i);
            const dateStr = current.toISOString().split('T')[0];
            const cell = document.createElement('div'); cell.className = 'calendar-day';
            if(dateStr === new Date().toISOString().split('T')[0]) cell.classList.add('today');
            const dailyStocks = data.filter(s => s.earningsDate === dateStr).sort((a,b)=>b.marketCap-a.marketCap);
            if (isMobile && type === 'week') {
                const dayName = current.toLocaleDateString('he-IL', {weekday:'long'});
                let innerHTML = `<div class="mobile-week-date">${current.getDate()}<span>${dayName}</span></div><div class="month-dot-container" style="justify-content: flex-start; align-content: flex-start;">`;
                if (dailyStocks.length > 0) {
                    dailyStocks.slice(0, 6).forEach(s => innerHTML += `<img src="https://assets.parqet.com/logos/symbol/${s.symbol}?format=png" class="month-dot">`);
                    if (dailyStocks.length > 6) innerHTML += `<div class="month-count-text">+${dailyStocks.length - 6}</div>`;
                } else innerHTML += `<span style="font-size:10px; color:var(--text-muted); width:100%; text-align:center; margin-top:10px;">××™×Ÿ</span>`;
                innerHTML += `</div>`; cell.innerHTML = innerHTML;
                if (dailyStocks.length > 0) cell.onclick = () => openDayModal(dateStr, dailyStocks);
            } else {
                if (isMobile && type === 'month') {
                    cell.innerHTML = `<div class="day-number">${current.getDate()}</div>`;
                    if (dailyStocks.length > 0) {
                        const dotContainer = document.createElement('div'); dotContainer.className = 'month-dot-container';
                        dailyStocks.slice(0, 4).forEach(s => { const img = document.createElement('img'); img.className = 'month-dot'; img.src = `https://assets.parqet.com/logos/symbol/${s.symbol}?format=png`; dotContainer.appendChild(img); });
                        if (dailyStocks.length > 4) { const count = document.createElement('div'); count.className = 'month-count-text'; count.innerText = `+`; dotContainer.appendChild(count); }
                        cell.appendChild(dotContainer); cell.onclick = () => openDayModal(dateStr, dailyStocks);
                    }
                } else {
                    cell.innerHTML = `<div class="day-number">${current.getDate()}</div>`;
                    if(type === 'month' && dailyStocks.length > 4) {
                        dailyStocks.slice(0,3).forEach(s => cell.appendChild(createCard(s, 'mini')));
                        const moreBtn = document.createElement('div'); moreBtn.className = 'show-more-btn'; moreBtn.innerText = `+${dailyStocks.length-3}`;
                        moreBtn.onclick = (e) => { e.stopPropagation(); openDayModal(dateStr, dailyStocks); }; cell.appendChild(moreBtn);
                    } else {
                        const cardType = (type==='week'?'full':'mini'); dailyStocks.forEach(s => cell.appendChild(createCard(s, cardType)));
                    }
                }
            }
            grid.appendChild(cell);
        }
        container.appendChild(grid);
    }

    function createCard(stock, type) {
        const isStarred = isStockStarred(stock.symbol);
        const starClass = isStarred ? 'active' : ''; const starIcon = isStarred ? 'â˜…' : 'â˜†';
        const [secClass, bgClass] = getSectorMeta(stock.sector);
        const timeIcon = stock.time === 'Before Market' ? 'â˜€ï¸' : (stock.time === 'After Market' ? 'ğŸŒ™' : '');
        const tvUrl = `https://www.tradingview.com/chart/?symbol=${stock.symbol}`;
        const yahooUrl = `https://finance.yahoo.com/quote/${stock.symbol}`;
        const el = document.createElement('div');
        el.onclick = () => openFinancialModal(stock);
        if (type === 'full') {
            el.className = 'stock-card';
            el.innerHTML = `
                <div class="card-strip ${secClass}"></div>
                <button class="star-btn ${starClass}" onclick="openListModal(event, '${stock.symbol}')">${starIcon}</button>
                <div class="card-top"><img src="https://assets.parqet.com/logos/symbol/${stock.symbol}?format=png" class="stock-logo" onerror="this.style.opacity=0"><div class="text-info"><span class="symbol">${stock.symbol}</span><span class="market-cap">$${formatMoney(stock.marketCap)}</span></div></div>
                <div class="company-name">${stock.name}</div>
                <div style="display:flex; justify-content:space-between; align-items:flex-end;"><span class="tag-text ${bgClass}">${stock.sector}</span>${stock.time ? `<span class="time-badge">${timeIcon} ${stock.time === 'Before Market' ? '×œ×¤× ×™' : (stock.time === 'After Market' ? '××—×¨×™' : '')}</span>` : ''}</div>
                <div class="card-actions" onclick="event.stopPropagation()"><a href="${tvUrl}" target="_blank" class="action-btn"><img src="https://www.google.com/s2/favicons?domain=tradingview.com" class="action-icon"></a><a href="${yahooUrl}" target="_blank" class="action-btn"><img src="https://www.google.com/s2/favicons?domain=finance.yahoo.com" class="action-icon"></a></div>
            `;
        } else {
            el.className = 'mini-card';
            el.innerHTML = `<div class="mini-strip ${secClass}"></div><button class="star-btn ${starClass}" onclick="openListModal(event, '${stock.symbol}')">${starIcon}</button><img src="https://assets.parqet.com/logos/symbol/${stock.symbol}?format=png" class="mini-logo" onerror="this.style.opacity=0"><div class="mini-info"><div class="mini-top"><span class="mini-sym">${stock.symbol}</span></div><span class="mini-cap">$${formatMoney(stock.marketCap)}</span></div><div class="mini-actions" onclick="event.stopPropagation()"><a href="${tvUrl}" target="_blank" class="mini-action-btn"><img src="https://www.google.com/s2/favicons?domain=tradingview.com" style="width:10px;"></a><a href="${yahooUrl}" target="_blank" class="mini-action-btn"><img src="https://www.google.com/s2/favicons?domain=finance.yahoo.com" style="width:10px;"></a></div>`;
        }
        return el;
    }
</script>
</body>
</html>
