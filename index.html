<!DOCTYPE html>
<html lang="he" dir="rtl" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Earnings Pro - Ultimate</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-color: #0b0e11; --card-bg: #151a21; --panel-bg: #1e2329;
            --text-main: #eaecef; --text-muted: #848e9c;
            --accent-blue: #2962ff; --accent-gold: #f0b90b; 
            --accent-green: #0ecb81; --accent-red: #f6465d;
            --border-color: #2b3139; --shadow: 0 4px 24px rgba(0,0,0,0.4);
            --modal-bg: rgba(0, 0, 0, 0.85);
        }
        
        * { box-sizing: border-box; }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Rubik', sans-serif; margin: 0; padding: 0; overflow-y: scroll; -webkit-tap-highlight-color: transparent; }
        
        /* HEADER */
        header { 
            background-color: var(--card-bg); border-bottom: 1px solid var(--border-color); 
            padding: 15px 20px; position: sticky; top: 0; z-index: 1000; box-shadow: var(--shadow); 
        }
        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .logo { font-size: 22px; font-weight: 700; letter-spacing: 1px; }
        .logo span { color: var(--accent-gold); }
        
        .date-nav { 
            display: flex; align-items: center; gap: 15px; background: var(--panel-bg); 
            padding: 5px 15px; border-radius: 8px; border: 1px solid var(--border-color); 
        }
        .nav-btn { background: none; border: none; color: var(--text-main); font-size: 18px; cursor: pointer; }
        
        .view-toggle { display: flex; gap: 2px; background: var(--panel-bg); padding: 3px; border-radius: 6px; border: 1px solid var(--border-color); }
        .view-btn { border: none; background: transparent; color: var(--text-muted); padding: 6px 15px; font-size: 13px; font-weight: 500; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        .view-btn.active { background: var(--border-color); color: var(--text-main); }

        .controls-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        input[type="text"] { 
            background: var(--panel-bg); border: 1px solid var(--border-color); color: var(--text-main); 
            padding: 0 15px; border-radius: 6px; font-size: 14px; height: 40px; outline: none; flex: 1; min-width: 200px;
        }
        input[type="text"]:focus { border-color: var(--accent-gold); }

        .filter-btn {
            background: var(--panel-bg); border: 1px solid var(--border-color); color: var(--text-main);
            padding: 0 20px; height: 40px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500;
        }
        
        /* CALENDAR GRID */
        .container { max-width: 1800px; margin: 0 auto; padding: 20px; }
        
        .calendar-grid { display: grid; gap: 10px; }
        .calendar-grid.month { grid-template-columns: repeat(7, 1fr); }
        .calendar-grid.week { grid-template-columns: repeat(5, 1fr); } /* 5 Business Days */
        
        .cal-header { text-align: center; color: var(--text-muted); padding: 10px; font-size: 14px; border-bottom: 2px solid var(--border-color); margin-bottom: 10px; }
        
        .cal-day { 
            background: var(--card-bg); border: 1px solid var(--border-color); min-height: 150px; border-radius: 8px; padding: 10px; 
            display: flex; flex-direction: column; gap: 8px; transition: 0.2s;
        }
        .cal-day.today { border: 1px solid var(--accent-gold); box-shadow: 0 0 10px rgba(240, 185, 11, 0.1); }
        .day-num { font-size: 14px; color: var(--text-muted); font-weight: bold; margin-bottom: 5px; }

        .stock-item {
            display: flex; align-items: center; gap: 8px; padding: 6px; background: var(--panel-bg); 
            border-radius: 6px; cursor: pointer; transition: 0.2s; border: 1px solid transparent;
        }
        .stock-item:hover { border-color: var(--accent-blue); transform: translateX(-2px); }
        .stock-img { width: 20px; height: 20px; border-radius: 50%; background: #fff; }
        .stock-sym { font-weight: 700; font-size: 12px; flex: 1; }
        .stock-time { font-size: 10px; color: var(--text-muted); }

        /* LIST VIEW */
        .list-group { margin-bottom: 25px; }
        .list-date { font-size: 16px; color: var(--accent-gold); margin-bottom: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; font-weight: 500; }
        .cards-flex { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        
        .card-full {
            background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px;
            display: flex; flex-direction: column; justify-content: space-between; height: 160px; cursor: pointer; position: relative; overflow: hidden;
        }
        .card-full:hover { border-color: var(--accent-gold); }
        .card-strip { position: absolute; top: 0; left: 0; width: 100%; height: 3px; }
        
        /* MODAL - PROFESSIONAL DASHBOARD */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-bg); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        .modal-overlay.open { display: flex; animation: fadeIn 0.2s; }
        
        .fin-modal { 
            background: var(--bg-color); width: 95%; max-width: 1100px; height: 90vh; border-radius: 12px; 
            border: 1px solid var(--border-color); display: flex; flex-direction: column; overflow: hidden; 
            box-shadow: 0 50px 100px -20px rgba(0,0,0,0.8); 
        }
        .fin-header { 
            padding: 20px 30px; border-bottom: 1px solid var(--border-color); background: var(--card-bg); 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .fin-body { flex: 1; overflow-y: auto; padding: 30px; }
        
        /* KPI Cards */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .kpi-card { 
            background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; 
            display: flex; flex-direction: column; justify-content: center; text-align: center;
        }
        .kpi-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px; }
        .kpi-value { font-size: 18px; font-weight: 700; letter-spacing: 0.5px; direction: ltr; }
        
        /* Chart Section */
        .chart-container { 
            background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; 
            margin-bottom: 30px; height: 350px; position: relative;
        }
        
        /* Table */
        .hist-table { width: 100%; border-collapse: collapse; font-size: 13px; text-align: left; direction: ltr; }
        .hist-table th { color: var(--text-muted); padding: 12px; border-bottom: 1px solid var(--border-color); font-weight: 500; }
        .hist-table td { padding: 12px; border-bottom: 1px solid var(--border-color); color: var(--text-main); }
        .hist-table tr:hover { background: var(--panel-bg); }
        
        /* Helpers */
        .val-green { color: var(--accent-green); } .val-red { color: var(--accent-red); }
        .badge { font-size: 10px; padding: 3px 8px; border-radius: 4px; background: var(--panel-bg); border: 1px solid var(--border-color); }
        .bg-tech { background: #2962ff; } .bg-fin { background: #0ecb81; } .bg-health { background: #f6465d; } .bg-other { background: #848e9c; }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        
        /* Filters */
        .advanced-filters { display: none; margin-top: 15px; background: var(--panel-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        .advanced-filters.show { display: block; }
        
        .slider-section { margin-top: 20px; padding: 0 10px; }
        .noUi-target { background: var(--border-color); border: none; height: 4px; }
        .noUi-connect { background: var(--accent-gold); }
        .slider-values { color: var(--accent-gold); font-family: monospace; font-size: 14px; margin-left: 10px; }
    </style>
</head>
<body>

<header>
    <div class="top-row">
        <div class="logo">Earnings<span>Pro</span></div>
        <div class="date-nav">
            <button class="nav-btn" onclick="changeDate(-1)">&#10094;</button>
            <div id="dateDisplay" style="font-weight:500; min-width:160px; text-align:center; direction:ltr;">-</div>
            <button class="nav-btn" onclick="changeDate(1)">&#10095;</button>
        </div>
        <div class="right-actions">
            <div class="view-toggle">
                <button class="view-btn active" onclick="switchView('list')" id="btn-list">×¨×©×™××”</button>
                <button class="view-btn" onclick="switchView('week')" id="btn-week">×©×‘×•×¢×™</button>
                <button class="view-btn" onclick="switchView('month')" id="btn-month">×—×•×“×©×™</button>
            </div>
        </div>
    </div>

    <div class="controls-row">
        <input type="text" id="searchInput" placeholder="×—×¤×© ×¡×™××•×œ ××• ×©× ×—×‘×¨×”...">
        <button class="filter-btn" onclick="document.querySelector('.advanced-filters').classList.toggle('show')">×¡×™× ×•×Ÿ ××ª×§×“× â–¼</button>
    </div>

    <div class="advanced-filters">
        <div style="color:var(--text-muted); margin-bottom:10px;">×¡× ×Ÿ ×œ×¤×™ ×©×•×•×™ ×©×•×§: <span id="sliderValues" class="slider-values">Loading...</span></div>
        <div class="slider-section">
            <div id="marketCapSlider"></div>
        </div>
        <div style="display:flex; gap:10px; margin-top:15px; flex-wrap:wrap;">
            <button class="view-btn" onclick="setSliderRange(1e9, 5e12)">×”×›×œ</button>
            <button class="view-btn" onclick="setSliderRange(200e9, 5e12)">×¢× ×§×™×•×ª (>200B)</button>
            <button class="view-btn" onclick="setSliderRange(10e9, 200e9)">×‘×™× ×•× ×™×•×ª</button>
        </div>
        <div id="stats-counter" style="margin-top:15px; font-size:12px; color:var(--text-muted);"></div>
    </div>
</header>

<div class="container" id="main-container">
    <div style="text-align:center; padding:50px; color:var(--text-muted);">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
</div>

<div class="modal-overlay" id="finModal" onclick="closeModal()">
    <div class="fin-modal" onclick="event.stopPropagation()">
        <div class="fin-header">
            <div style="display:flex; align-items:center; gap:15px;">
                <img id="mLogo" src="" style="width:36px; height:36px; border-radius:50%; background:#fff; padding:2px;">
                <div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <h2 id="mSymbol" style="margin:0; font-size:24px;">AAPL</h2>
                        <span id="mSector" class="badge">Tech</span>
                    </div>
                    <div id="mName" style="font-size:13px; color:var(--text-muted);">Apple Inc.</div>
                </div>
            </div>
            <div style="text-align:left;">
                <span style="font-size:28px; cursor:pointer; color:var(--text-muted);" onclick="closeModal()">âœ•</span>
            </div>
        </div>
        
        <div class="fin-body">
            
            <div class="kpi-grid">
                <div class="kpi-card"><span class="kpi-label">Market Cap</span><span class="kpi-value" id="mCap">-</span></div>
                <div class="kpi-card"><span class="kpi-label">P/E Ratio</span><span class="kpi-value" id="mPE">-</span></div>
                <div class="kpi-card"><span class="kpi-label">Revenue (TTM)</span><span class="kpi-value" id="mRev">-</span></div>
                <div class="kpi-card"><span class="kpi-label">Dividend</span><span class="kpi-value" id="mDiv">-</span></div>
                <div class="kpi-card"><span class="kpi-label">ROE</span><span class="kpi-value" id="mROE">-</span></div>
            </div>

            <div class="chart-container">
                <canvas id="mainChart"></canvas>
            </div>

            <div id="mGuidance" style="margin-bottom:20px; padding:15px; background:var(--panel-bg); border-radius:8px; border:1px solid var(--border-color);"></div>

            <h3 style="margin-bottom:15px; font-size:16px; color:var(--text-main);">×”×™×¡×˜×•×¨×™×” ×¨×‘×¢×•× ×™×ª</h3>
            <div style="overflow-x:auto;">
                <table class="hist-table" id="mTable">
                    <thead><tr><th>Date</th><th>Revenue</th><th>Net Income</th><th>Margin</th><th>Free Cash Flow</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <div style="margin-top:20px; display:flex; gap:15px; justify-content:center;">
                <a id="linkYahoo" href="#" target="_blank" class="view-btn active" style="text-decoration:none;">Yahoo Finance</a>
                <a id="linkTrading" href="#" target="_blank" class="view-btn active" style="text-decoration:none;">TradingView</a>
            </div>
        </div>
    </div>
</div>

<script>
    // --- SAFE DOM UPDATES ---
    function setText(id, val) { const el = document.getElementById(id); if(el) el.innerText = (val!==undefined && val!==null) ? val : "-"; }
    function setHtml(id, val) { const el = document.getElementById(id); if(el) el.innerHTML = val || ""; }
    
    // --- GLOBALS ---
    let allData = [], historyData = {};
    let currentView = 'list'; // 'list', 'week', 'month'
    let navigationDate = new Date();
    let minCap = 1e9, maxCap = 5e12;
    let sliderInstance = null;
    let chartInstance = null;

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', async () => {
        const loader = document.getElementById('main-container');
        const buster = new Date().getTime();
        
        try {
            // 1. Fetch Main Data
            const res = await fetch(`./data.json?v=${buster}`);
            if (!res.ok) throw new Error("Missing data.json");
            const data = await res.json();
            allData = data.filter(d => d.earningsDate !== '?' && d.earningsDate !== 'TBD');
            
            // 2. Fetch History (Optional)
            fetch(`./history_data.json?v=${buster}`)
                .then(r => r.json())
                .then(h => { historyData = h; })
                .catch(() => console.log("History not available"));

            // 3. Init UI
            initSlider();
            updateDateDisplay();
            applyFilters(); // First Render

        } catch (err) {
            loader.innerHTML = `<div style="color:#f6465d;">×©×’×™××”: ${err.message}<br>× × ×œ×”×¨×™×¥ ××ª get_data.py</div>`;
        }
    });

    // --- RENDER LOGIC (THE HEART) ---
    function applyFilters() {
        const q = document.getElementById('searchInput').value.toLowerCase().trim();
        
        // Filter Logic
        let filtered = allData.filter(d => {
            const matchCap = d.marketCap >= minCap && d.marketCap <= maxCap;
            const matchSearch = q === '' || d.symbol.toLowerCase().includes(q) || d.name.toLowerCase().includes(q);
            return matchCap && matchSearch;
        });
        
        // Sort by Date
        filtered.sort((a, b) => new Date(a.earningsDate) - new Date(b.earningsDate));
        
        setText('stats-counter', `× ××¦××• ${filtered.length} ×ª×•×¦××•×ª`);
        const container = document.getElementById('main-container');
        container.innerHTML = '';

        if (currentView === 'list') {
            renderListView(container, filtered);
        } else if (currentView === 'week') {
            renderWeekView(container, filtered);
        } else {
            renderMonthView(container, filtered);
        }
    }

    // --- VIEW 1: LIST ---
    function renderListView(container, data) {
        // Filter by current viewed range isn't strictly necessary for list, but let's filter next 7 days from nav date
        const start = new Date(navigationDate); start.setHours(0,0,0,0);
        const end = new Date(start); end.setDate(end.getDate() + 7);
        
        const subset = data.filter(d => {
            const dt = new Date(d.earningsDate);
            return dt >= start && dt < end;
        });

        if(subset.length === 0) { container.innerHTML = '<div style="text-align:center; padding:30px; color:var(--text-muted)">××™×Ÿ ×“×•×—×•×ª ×‘×ª××¨×™×›×™× ××œ×•</div>'; return; }

        const grouped = {};
        subset.forEach(s => { if(!grouped[s.earningsDate]) grouped[s.earningsDate]=[]; grouped[s.earningsDate].push(s); });
        
        Object.keys(grouped).sort().forEach(date => {
            const dObj = new Date(date);
            const dateHeader = document.createElement('div');
            dateHeader.className = 'list-date';
            dateHeader.innerText = `${date} - ${dObj.toLocaleDateString('he-IL', {weekday:'long'})}`;
            container.appendChild(dateHeader);
            
            const grid = document.createElement('div');
            grid.className = 'cards-flex';
            grouped[date].sort((a,b)=>b.marketCap-a.marketCap).forEach(s => grid.appendChild(createStockCard(s)));
            container.appendChild(grid);
        });
    }

    // --- VIEW 2: WEEK CALENDAR (RESTORED!) ---
    function renderWeekView(container, data) {
        // Calculate start of week (Sunday)
        const current = new Date(navigationDate);
        const day = current.getDay(); 
        const startOfWeek = new Date(current); 
        startOfWeek.setDate(current.getDate() - day);
        
        const grid = document.createElement('div');
        grid.className = 'calendar-grid week';
        
        // Loop 0 (Sun) to 4 (Thu) or 6 (Sat)
        for(let i=0; i<5; i++) { 
            const d = new Date(startOfWeek);
            d.setDate(startOfWeek.getDate() + i);
            const dateStr = d.toISOString().split('T')[0];
            
            const col = document.createElement('div');
            col.className = 'cal-day';
            const today = new Date().toISOString().split('T')[0];
            if(dateStr === today) col.classList.add('today');
            
            col.innerHTML = `<div class="day-num">${d.toLocaleDateString('he-IL',{weekday:'long'})} ${d.getDate()}/${d.getMonth()+1}</div>`;
            
            // Find stocks for this day
            const daily = data.filter(s => s.earningsDate === dateStr).sort((a,b)=>b.marketCap-a.marketCap);
            
            daily.forEach(s => {
                const item = document.createElement('div');
                item.className = 'stock-item';
                item.innerHTML = `
                    <img src="https://assets.parqet.com/logos/symbol/${s.symbol}?format=png" class="stock-img" onerror="this.style.opacity=0">
                    <span class="stock-sym">${s.symbol}</span>
                    <span class="stock-time">${s.time.includes('After')?'ğŸŒ™':'â˜€ï¸'}</span>
                `;
                item.onclick = () => openModal(s);
                col.appendChild(item);
            });
            
            grid.appendChild(col);
        }
        container.appendChild(grid);
    }

    // --- VIEW 3: MONTH CALENDAR ---
    function renderMonthView(container, data) {
        const year = navigationDate.getFullYear();
        const month = navigationDate.getMonth();
        
        const grid = document.createElement('div');
        grid.className = 'calendar-grid month';
        
        // Days in month
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        for(let i=1; i<=daysInMonth; i++) {
            const d = new Date(year, month, i);
            const dateStr = d.toISOString().split('T')[0];
            
            const cell = document.createElement('div');
            cell.className = 'cal-day';
            cell.style.minHeight = '100px';
            
            cell.innerHTML = `<div class="day-num">${i}</div>`;
            
            const daily = data.filter(s => s.earningsDate === dateStr);
            if(daily.length > 0) {
                // Show only dots/small icons for month view to save space
                const dots = document.createElement('div');
                dots.style.display = 'flex'; dots.style.flexWrap = 'wrap'; dots.style.gap = '2px';
                
                daily.sort((a,b)=>b.marketCap-a.marketCap).slice(0, 6).forEach(s => {
                    const img = document.createElement('img');
                    img.src = `https://assets.parqet.com/logos/symbol/${s.symbol}?format=png`;
                    img.style.width = '20px'; img.style.height = '20px'; img.style.borderRadius = '50%';
                    img.style.cursor = 'pointer';
                    img.onclick = (e) => { e.stopPropagation(); openModal(s); };
                    dots.appendChild(img);
                });
                if(daily.length > 6) {
                    const more = document.createElement('span');
                    more.innerText = `+${daily.length-6}`;
                    more.style.fontSize = '10px'; more.style.color = 'var(--text-muted)';
                    dots.appendChild(more);
                }
                cell.appendChild(dots);
            }
            grid.appendChild(cell);
        }
        container.appendChild(grid);
    }

    // --- CARD CREATOR ---
    function createStockCard(s) {
        const el = document.createElement('div');
        el.className = 'card-full';
        
        let strip = '#848e9c';
        if(s.sector.includes('Tech')) strip='#2962ff';
        if(s.sector.includes('Fin')) strip='#0ecb81';
        
        el.innerHTML = `
            <div class="card-strip" style="background:${strip}"></div>
            <div style="display:flex; align-items:center; gap:10px;">
                <img src="https://assets.parqet.com/logos/symbol/${s.symbol}?format=png" style="width:32px; height:32px; border-radius:50%; background:#fff; padding:2px;" onerror="this.style.opacity=0">
                <div>
                    <div style="font-weight:700; font-size:16px;">${s.symbol}</div>
                    <div style="font-size:11px; color:var(--text-muted);">$${formatNum(s.marketCap)}</div>
                </div>
            </div>
            <div style="font-size:12px; color:var(--text-muted); overflow:hidden; white-space:nowrap; text-overflow:ellipsis; direction:ltr; text-align:left;">${s.name}</div>
            <div style="display:flex; justify-content:space-between; margin-top:auto;">
                <span class="badge">${s.sector}</span>
                <span class="badge">${s.time.includes('After')?'ğŸŒ™':'â˜€ï¸'}</span>
            </div>
        `;
        el.onclick = () => openModal(s);
        return el;
    }

    // --- MODAL & CHART LOGIC ---
    function openModal(s) {
        // Populate Texts
        setText('mSymbol', s.symbol);
        setText('mName', s.name);
        document.getElementById('mLogo').src = `https://assets.parqet.com/logos/symbol/${s.symbol}?format=png`;
        
        setText('mCap', formatNum(s.marketCap));
        setText('mPE', s.trailingPE ? s.trailingPE.toFixed(2) : "-");
        setText('mRev', formatNum(s.revenue));
        setText('mDiv', s.dividendYield ? (s.dividendYield*100).toFixed(2)+"%" : "-");
        
        const roeEl = document.getElementById('mROE');
        roeEl.innerText = s.returnOnEquity ? (s.returnOnEquity*100).toFixed(2)+"%" : "-";
        roeEl.className = (s.returnOnEquity > 0.15) ? "kpi-value val-green" : "kpi-value";

        // Links
        document.getElementById('linkYahoo').href = `https://finance.yahoo.com/quote/${s.symbol}`;
        document.getElementById('linkTrading').href = `https://www.tradingview.com/chart/?symbol=${s.symbol}`;

        // History Processing
        const hist = historyData[s.symbol];
        const tableBody = document.querySelector('#mTable tbody');
        tableBody.innerHTML = '';
        
        if(hist) {
            // 1. Chart
            const ctx = document.getElementById('mainChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            
            // Prepare Data (Reverse for chart left-to-right)
            const dates = hist.quarterlyHistory.map(h => h.date).reverse();
            const revs = hist.quarterlyHistory.map(h => h.revenue).reverse();
            const profits = hist.quarterlyHistory.map(h => h.netIncome).reverse();
            
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [
                        { label: '×”×›× ×¡×•×ª', data: revs, backgroundColor: '#2962ff', borderRadius:4 },
                        { label: '×¨×•×•×— × ×§×™', data: profits, backgroundColor: '#0ecb81', borderRadius:4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#848e9c' } } },
                    scales: {
                        x: { ticks: { color: '#848e9c' }, grid: { display:false } },
                        y: { ticks: { color: '#848e9c', callback: val => '$' + formatNum(val) }, grid: { color: '#2b3139' } }
                    }
                }
            });

            // 2. Analysis Text
            let html = "";
            if(hist.yoyRevenueGrowth) {
                const color = hist.yoyRevenueGrowth > 0 ? "val-green" : "val-red";
                html += `<div><strong>×¦××™×—×” ×©× ×ª×™×ª (YoY):</strong> <span class="${color}">${hist.yoyRevenueGrowth}%</span></div>`;
            }
            if(s.forwardPE && s.trailingPE) {
                const sentiment = s.forwardPE < s.trailingPE ? "×—×™×•×‘×™ (×¦×¤×™ ×œ×¢×œ×™×™×” ×‘×¨×•×•×—×™×)" : "×©×œ×™×œ×™/××¢×•×¨×‘";
                html += `<div><strong>×ª×—×–×™×ª ×©×•×§ (Forward P/E):</strong> ${sentiment}</div>`;
            }
            setHtml('mGuidance', html);

            // 3. Table
            hist.quarterlyHistory.forEach(q => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${q.date}</td>
                    <td>${formatNum(q.revenue)}</td>
                    <td class="${q.netIncome>0?'val-green':'val-red'}">${formatNum(q.netIncome)}</td>
                    <td>${q.margin}%</td>
                    <td>${formatNum(q.freeCashFlow)}</td>
                `;
                tableBody.appendChild(tr);
            });

        } else {
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">××™×Ÿ × ×ª×•× ×™× ×”×™×¡×˜×•×¨×™×™×</td></tr>';
            setHtml('mGuidance', '× ×ª×•× ×™× ×”×™×¡×˜×•×¨×™×™× ×—×¡×¨×™×. ×”×¨×¥ ××ª get_history.py');
            if(chartInstance) chartInstance.destroy();
        }

        document.getElementById('finModal').classList.add('open');
    }

    function closeModal() { document.getElementById('finModal').classList.remove('open'); }

    // --- SLIDER ---
    function initSlider() {
        const s = document.getElementById('marketCapSlider');
        if(!s || s.noUiSlider) return; // Prevent double init
        
        noUiSlider.create(s, {
            start: [1e9, 5e12], connect: true,
            range: { 'min': 1e9, '30%': 50e9, '70%': 200e9, 'max': 5e12 }
        });
        sliderInstance = s.noUiSlider;
        s.noUiSlider.on('update', vals => {
            minCap = parseFloat(vals[0]); maxCap = parseFloat(vals[1]);
            setText('sliderValues', `$${formatNum(minCap)} - $${formatNum(maxCap)}`);
            applyFilters();
        });
    }
    function setSliderRange(min, max) { if(sliderInstance) sliderInstance.set([min, max]); }

    // --- NAV ---
    function changeDate(d) {
        if(currentView==='month') navigationDate.setMonth(navigationDate.getMonth()+d);
        else navigationDate.setDate(navigationDate.getDate()+(d*7));
        updateDateDisplay(); applyFilters();
    }
    function switchView(v) {
        currentView = v;
        document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-${v}`).classList.add('active');
        updateDateDisplay(); applyFilters();
    }
    function updateDateDisplay() {
        const opts = { month: 'long', year: 'numeric' };
        let txt = "";
        if(currentView === 'month') {
            txt = navigationDate.toLocaleDateString('he-IL', opts);
        } else {
            const curr = new Date(navigationDate);
            const day = curr.getDay(); 
            const start = new Date(curr); start.setDate(curr.getDate() - day);
            const end = new Date(start); end.setDate(start.getDate() + 6);
            txt = `${start.getDate()}/${start.getMonth()+1} - ${end.getDate()}/${end.getMonth()+1}`;
        }
        setText('dateDisplay', txt);
    }

    // --- FORMATTER ---
    function formatNum(n) {
        if(!n) return "-";
        if(n >= 1e12) return (n/1e12).toFixed(2) + "T";
        if(n >= 1e9) return (n/1e9).toFixed(2) + "B";
        if(n >= 1e6) return (n/1e6).toFixed(2) + "M";
        return n.toLocaleString();
    }

    document.getElementById('searchInput').addEventListener('keyup', applyFilters);
</script>
</body>
</html>
